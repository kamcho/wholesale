{% extends 'vendor/base.html' %}
{% load static %}

{% block title %}Add Attribute - {{ product.name }}{% endblock %}

{% block extra_css %}
<style>
  .attribute-card {
    transition: all 0.3s ease;
    border: 2px solid transparent;
  }
  .attribute-card:hover {
    border-color: var(--bs-primary);
    box-shadow: 0 0.5rem 1rem rgba(0, 0, 0, 0.15);
  }
  .attribute-card.active {
    border-color: var(--bs-primary);
    background-color: rgba(13, 110, 253, 0.05);
  }
  .nav-tabs .nav-link {
    color: #6c757d;
    font-weight: 500;
  }
  .nav-tabs .nav-link.active {
    color: #0d6efd;
    font-weight: 600;
  }
  .form-section {
    display: none;
  }
  .form-section.active {
    display: block;
    animation: fadeIn 0.3s ease-in-out;
  }
  @keyframes fadeIn {
    from { opacity: 0; transform: translateY(10px); }
    to { opacity: 1; transform: translateY(0); }
  }
</style>
{% endblock %}

{% block content %}
<div class="container-fluid px-4">
  <div class="d-flex justify-content-between flex-wrap flex-md-nowrap align-items-center pt-3 pb-2 mb-4 border-bottom">
    <div>
      <nav aria-label="breadcrumb">
        <ol class="breadcrumb">
          <li class="breadcrumb-item"><a href="{% url 'vendor:product_list' %}">Products</a></li>
          <li class="breadcrumb-item"><a href="{% url 'vendor:product_detail' product.id %}">{{ product.name|truncatechars:20 }}</a></li>
          <li class="breadcrumb-item"><a href="{% url 'vendor:variation_detail' variation.id %}">Variation: {{ variation.name|truncatechars:20 }}</a></li>
          <li class="breadcrumb-item active" aria-current="page">Add Attribute</li>
        </ol>
      </nav>
      <h1 class="h2 mb-0">
        <i class="fas fa-tag text-primary me-2"></i>Add Product Attribute
      </h1>
    </div>
    <div class="btn-toolbar mb-2 mb-md-0">
      <a href="{% url 'vendor:variation_detail' variation.id %}" class="btn btn-outline-secondary">
        <i class="fas fa-arrow-left me-2"></i>Back to Variation
      </a>
    </div>
  </div>

  <div class="row">
    <div class="col-lg-8 mx-auto">
      <div class="card shadow-sm mb-4">
        <div class="card-header bg-light py-3">
          <h5 class="mb-0">
            <i class="fas fa-tags text-primary me-2"></i>Add Attribute to "{{ variation.name }}"
          </h5>
        </div>
        <div class="card-body">
          <!-- Product Info Alert -->
          <div class="alert alert-light border mb-4">
            <div class="d-flex align-items-center">
              <div class="flex-shrink-0">
                <i class="fas fa-info-circle text-primary fs-4 me-3"></i>
              </div>
              <div>
                <h6 class="mb-1">Product Information</h6>
                <div class="text-muted small">
                  <span class="d-inline-block me-3"><strong>Product:</strong> {{ product.name }}</span>
                  <span class="d-inline-block"><strong>Variation:</strong> {{ variation.name }}</span>
                </div>
              </div>
            </div>
          </div>

          <form method="post" id="attributeForm">
            {% csrf_token %}
            <input type="hidden" name="form_type" id="formType" value="new">

            {% if form.non_field_errors %}
            <div class="alert alert-danger" role="alert">
              <i class="fas fa-exclamation-circle me-2"></i>
              {% for error in form.non_field_errors %}
                <div>{{ error }}</div>
              {% endfor %}
            </div>
            {% endif %}

            <!-- Tab Navigation -->
            <ul class="nav nav-tabs nav-fill mb-4" id="attributeTabs" role="tablist">
              <li class="nav-item" role="presentation">
                <button class="nav-link active" id="new-tab" data-bs-toggle="tab" data-bs-target="#new-attribute" type="button" role="tab" data-form-type="new">
                  <i class="fas fa-plus-circle me-2"></i>Create New Attribute
                </button>
              </li>
              <li class="nav-item" role="presentation">
                <button class="nav-link" id="existing-tab" data-bs-toggle="tab" data-bs-target="#existing-attribute" type="button" role="tab" data-form-type="existing">
                  <i class="fas fa-list me-2"></i>Use Existing Attribute
                </button>
              </li>
            </ul>

            <!-- Tab Content -->
            <div class="tab-content">
              <!-- New Attribute Form -->
              <div class="tab-pane fade show active" id="new-attribute" role="tabpanel" aria-labelledby="new-tab">
                <div class="card border-0">
                  <div class="card-body p-4">
                    <h5 class="mb-4"><i class="fas fa-magic me-2 text-primary"></i>Create a New Attribute</h5>
                    <div class="row g-3">
                      <div class="col-md-6">
                        <label for="{{ form.new_attribute_name.id_for_label }}" class="form-label">
                          <i class="fas fa-tag me-1 text-muted"></i> Attribute Name
                        </label>
                        <div class="input-group">
                          <span class="input-group-text"><i class="fas fa-font"></i></span>
                          {{ form.new_attribute_name }}
                        </div>
                        {% if form.new_attribute_name.errors %}
                          <div class="invalid-feedback d-block">
                            {% for error in form.new_attribute_name.errors %}
                              <div><i class="fas fa-exclamation-circle me-1"></i>{{ error }}</div>
                            {% endfor %}
                          </div>
                        {% endif %}
                        <div class="form-text text-muted mt-1">
                          <small>e.g., Color, Size, Material, Pattern</small>
                        </div>
                      </div>
                      <div class="col-md-6">
                        <label for="{{ form.new_attribute_value.id_for_label }}" class="form-label">
                          <i class="fas fa-tag me-1 text-muted"></i> Attribute Value
                        </label>
                        <div class="input-group">
                          <span class="input-group-text"><i class="fas fa-palette"></i></span>
                          {{ form.new_attribute_value }}
                        </div>
                        {% if form.new_attribute_value.errors %}
                          <div class="invalid-feedback d-block">
                            {% for error in form.new_attribute_value.errors %}
                              <div><i class="fas fa-exclamation-circle me-1"></i>{{ error }}</div>
                            {% endfor %}
                          </div>
                        {% endif %}
                        <div class="form-text text-muted mt-1">
                          <small>e.g., Red, Large, Cotton, Striped</small>
                        </div>
                      </div>
                      <div class="col-12">
                        <label for="{{ form.new_attribute_description.id_for_label }}" class="form-label">
                          <i class="fas fa-align-left me-1 text-muted"></i> Description (Optional)
                        </label>
                        {{ form.new_attribute_description }}
                        {% if form.new_attribute_description.errors %}
                          <div class="invalid-feedback d-block">
                            {% for error in form.new_attribute_description.errors %}
                              <div><i class="fas fa-exclamation-circle me-1"></i>{{ error }}</div>
                            {% endfor %}
                          </div>
                        {% endif %}
                      </div>
                    </div>
                  </div>
                </div>
              </div>

              <!-- Existing Attribute Form -->
              <div class="tab-pane fade" id="existing-attribute" role="tabpanel" aria-labelledby="existing-tab">
                <div class="card border-0">
                  <div class="card-body p-4">
                    <h5 class="mb-4"><i class="fas fa-list-ul me-2 text-primary"></i>Select Existing Attribute</h5>
                    <div class="mb-3">
                      <label for="{{ form.existing_value.id_for_label }}" class="form-label">
                        <i class="fas fa-tags me-1 text-muted"></i> Choose Attribute Value
                      </label>
                      <div class="input-group">
                        <span class="input-group-text"><i class="fas fa-search"></i></span>
                        {{ form.existing_value }}
                      </div>
                      {% if form.existing_value.errors %}
                        <div class="invalid-feedback d-block">
                          {% for error in form.existing_value.errors %}
                            <div><i class="fas fa-exclamation-circle me-1"></i>{{ error }}</div>
                          {% endfor %}
                        </div>
                      {% endif %}
                      <div class="form-text text-muted mt-1">
                        <small>Select an existing attribute value from the dropdown</small>
                      </div>
                    </div>
                    
                    <div class="alert alert-info mt-4">
                      <i class="fas fa-lightbulb me-2"></i>
                      <strong>Tip:</strong> Can't find what you're looking for? 
                      <a href="#" class="alert-link" onclick="document.getElementById('new-tab').click(); return false;">
                        Create a new attribute
                      </a>
                      instead.
                    </div>
                  </div>
                </div>
              </div>
            </div>

            <div class="d-flex justify-content-between align-items-center mt-4 pt-3 border-top">
              <a href="{% url 'vendor:variation_detail' variation.id %}" class="btn btn-outline-secondary">
                <i class="fas fa-times me-2"></i>Cancel
              </a>
              <button type="submit" class="btn btn-primary px-4">
                <i class="fas fa-save me-2"></i>Save Attribute
              </button>
            </div>
          </form>
        </div>
      </div>
    </div>
  </div>
</div>
{% endblock %}

{% block extra_js %}
<script>
  document.addEventListener('DOMContentLoaded', function() {
    // Handle tab switching
    const tabs = document.querySelectorAll('[data-bs-toggle="tab"]');
    tabs.forEach(tab => {
      tab.addEventListener('shown.bs.tab', function (e) {
        const formType = e.target.getAttribute('data-form-type');
        document.getElementById('formType').value = formType;
      });
    });

    // Form submission handling
    const form = document.getElementById('attributeForm');
    if (form) {
      form.addEventListener('submit', function(e) {
        const formType = document.getElementById('formType').value;
        
        // Validate based on active tab
        if (formType === 'new') {
          const nameField = document.getElementById('{{ form.new_attribute_name.id_for_label }}');
          const valueField = document.getElementById('{{ form.new_attribute_value.id_for_label }}');
          
          if (!nameField.value.trim() || !valueField.value.trim()) {
            e.preventDefault();
            alert('Please fill in all required fields for the new attribute.');
            return false;
          }
        } else {
          const existingValue = document.getElementById('{{ form.existing_value.id_for_label }}');
          if (!existingValue.value) {
            e.preventDefault();
            alert('Please select an existing attribute value.');
            return false;
          }
        }
      });
    }
  });
</script>
{% endblock %}
