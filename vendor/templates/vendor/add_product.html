{% extends 'vendor/base.html' %}

{% block title %}Add Product - Vendor Panel{% endblock %}

{% block content %}
<div class="d-flex justify-content-between flex-wrap flex-md-nowrap align-items-center pt-3 pb-2 mb-3 border-bottom">
    <h1 class="h2">
        <i class="fas fa-plus-circle me-2"></i>Add New Product
    </h1>
</div>

<div class="row">
    <div class="col-lg-8">
        <div class="card">
            <div class="card-header">
                <h5 class="card-title mb-0">Product Information</h5>
            </div>
            <div class="card-body">
                <form method="post">
                    {% csrf_token %}
                    {% if form.non_field_errors %}
                    <div class="alert alert-danger" role="alert">
                        {% for error in form.non_field_errors %}
                            <div>{{ error }}</div>
                        {% endfor %}
                    </div>
                    {% endif %}
                    
                    <div class="row">
                        <div class="col-md-6 mb-3">
                            <label for="{{ form.name.id_for_label }}" class="form-label">Product Name *</label>
                            {{ form.name }}
                            {% if form.name.errors %}
                                <div class="text-danger small mt-1">
                                    {% for error in form.name.errors %}
                                        <div>{{ error }}</div>
                                    {% endfor %}
                                </div>
                            {% endif %}
                        </div>
                        
                        
                    </div>
                    
                    

                    <div class="row">
                        <div class="col-md-6 mb-3">
                            <label for="{{ form.moq.id_for_label }}" class="form-label">Minimum Order Quantity (MOQ) *</label>
                            {{ form.moq }}
                            {% if form.moq.errors %}
                                <div class="text-danger small mt-1">
                                    {% for error in form.moq.errors %}
                                        <div>{{ error }}</div>
                                    {% endfor %}
                                </div>
                            {% endif %}
                            <div class="form-text">Minimum quantity required for orders</div>
                        </div>
                        
                        <div class="col-md-6 mb-3">
                            <!-- Empty column for layout balance -->
                        </div>
                    </div>
                    
                    <div class="row">
                        <div class="col-md-12 mb-3">
                            <label class="form-label">Categories *</label>
                            <div id="category-selector">
                                <!-- Category filter and categories will be loaded here by JavaScript -->
                            </div>
                            <!-- Hidden field to store the final selected category ID -->
                            <input type="hidden" name="categories" id="selected-category" required>
                            <div id="category-path" class="mt-2 small text-muted"></div>
                            {% if form.categories.errors %}
                                <div class="text-danger small mt-1">
                                    {% for error in form.categories.errors %}
                                        <div>{{ error }}</div>
                                    {% endfor %}
                                </div>
                            {% endif %}
                            <div class="form-text">Select a category filter first, then choose a specific category.</div>
                        </div>
                        
                        <div class="col-md-6 mb-3">
                            <label for="{{ form.business.id_for_label }}" class="form-label">Business *</label>
                            {{ form.business }}
                            {% if form.business.errors %}
                                <div class="text-danger small mt-1">
                                    {% for error in form.business.errors %}
                                        <div>{{ error }}</div>
                                    {% endfor %}
                                </div>
                            {% endif %}
                        </div>
                    </div>
                    
                    <!-- Placeholder: After save, redirect to attribute management if product_type has attributes -->
                    
                    <div class="mb-3">
                        <label for="{{ form.description.id_for_label }}" class="form-label">Description</label>
                        {{ form.description }}
                        {% if form.description.errors %}
                            <div class="text-danger small mt-1">
                                {% for error in form.description.errors %}
                                    <div>{{ error }}</div>
                                {% endfor %}
                            </div>
                        {% endif %}
                    </div>
                    
                    <div class="d-flex gap-2">
                        <button type="submit" class="btn btn-primary">
                            <i class="fas fa-save me-2"></i>Add Product
                        </button>
                        <a href="{% url 'vendor:product_list' %}" class="btn btn-secondary">
                            <i class="fas fa-times me-2"></i>Cancel
                        </a>
                    </div>

                    {# Fallback: render any remaining fields not explicitly shown above #}
                    {% for field in form.visible_fields %}
                        {% if field.name != 'name' and field.name != 'moq' and field.name != 'categories' and field.name != 'business' and field.name != 'description' and field.name != 'user' %}
                        <div class="mt-3">
                            <label for="{{ field.id_for_label }}" class="form-label">{{ field.label }}{% if field.field.required %} *{% endif %}</label>
                            {{ field }}
                            {% if field.help_text %}<div class="form-text">{{ field.help_text }}</div>{% endif %}
                            {% if field.errors %}
                            <div class="text-danger small mt-1">
                                {% for error in field.errors %}
                                <div>{{ error }}</div>
                                {% endfor %}
                            </div>
                            {% endif %}
                        </div>
                        {% endif %}
                    {% endfor %}
                </form>
            </div>
        </div>
    </div>
    
    <div class="col-lg-4">
        <div class="card">
            <div class="card-header">
                <h6 class="card-title mb-0">
                    <i class="fas fa-info-circle me-2"></i>Tips
                </h6>
            </div>
            <div class="card-body">
                <ul class="list-unstyled mb-0">
                    <li class="mb-2">
                        <i class="fas fa-check text-success me-2"></i>
                        Choose a clear, descriptive product name
                    </li>
                    <li class="mb-2">
                        <i class="fas fa-check text-success me-2"></i>
                        Set a competitive price for your market
                    </li>
                    <li class="mb-2">
                        <i class="fas fa-check text-success me-2"></i>
                        Set appropriate MOQ for wholesale orders
                    </li>
                    <li class="mb-2">
                        <i class="fas fa-check text-success me-2"></i>
                        Select the most appropriate category
                    </li>
                    <li class="mb-2">
                        <i class="fas fa-check text-success me-2"></i>
                        Write a detailed description
                    </li>
                    <li class="mb-0">
                        <i class="fas fa-check text-success me-2"></i>
                        You can add images after creating the product
                    </li>
                </ul>
            </div>
        </div>
        
        {% if not user.businesses.exists %}
        <div class="card mt-3">
            <div class="card-header">
                <h6 class="card-title mb-0 text-warning">
                    <i class="fas fa-exclamation-triangle me-2"></i>No Business Found
                </h6>
            </div>
            <div class="card-body">
                <p class="card-text small">
                    You need to create a business first before adding products.
                </p>
                <a href="{% url 'vendor:add_business' %}" class="btn btn-warning btn-sm">
                    <i class="fas fa-plus me-1"></i>Create Business
                </a>
            </div>
        </div>
        {% endif %}
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
<script>
$(document).ready(function() {
    const categoryContainer = $('#category-selector');
    const selectedCategory = $('#selected-category');
    const categoryPath = $('#category-path');
    let selectedCategories = [];
    let allFilters = [];

    // Load main filters and categories on page load
    loadFilters();

    // Handle category selection
    $(document).on('change', '.category-select', function() {
        const level = parseInt($(this).data('level'));
        const value = $(this).val();
        const optionText = $(this).find('option:selected').text();
        
        // Clear any existing selections after this level
        selectedCategories = selectedCategories.slice(0, level);
        
        if (value) {
            if (level === 0) {
                // Selected a filter
                const filterId = value.replace('filter_', '');
                selectedCategories[level] = {
                    id: filterId,
                    name: optionText,
                    isFilter: true
                };
                // Load categories for this filter
                loadCategories(level + 1, filterId);
            } else {
                // Selected a category
                selectedCategories[level] = {
                    id: value,
                    name: optionText,
                    isFilter: false
                };
                // Update the hidden field with the selected category ID
                selectedCategory.val(value);
            }
            
            // Update the path display
            updateCategoryPath();
        } else {
            // Clear was selected
            if (level === 0) {
                // If clearing the filter, remove category select
                $('.category-level').slice(1).remove();
                selectedCategory.val('');
            }
            updateCategoryPath();
        }
    });

    // Update the category path display
    function updateCategoryPath() {
        if (selectedCategories.length > 0) {
            const pathText = selectedCategories.map(item => item.name).join(' > ');
            categoryPath.text('Selected: ' + pathText);
        } else {
            categoryPath.text('');
        }
    }

    // Function to load filters
    function loadFilters() {
        const url = '{% url "vendor:get_categories" %}';
        const loadingId = 'category-loading';
        
        // Show loading state
        $(`#${loadingId}`).remove();
        categoryContainer.append(`<div id="${loadingId}" class="text-muted small mb-2">Loading categories...</div>`);

        // Make AJAX request to get filters
        $.getJSON(url)
            .done(function(filters) {
                // Remove loading indicator
                $(`#${loadingId}`).remove();
                categoryContainer.empty();
                
                if (filters && filters.length > 0) {
                    allFilters = filters; // Store for later use
                    
                    // Create filter select
                    const filterSelect = `
                        <div class="category-level mb-3" data-level="0">
                            <label class="form-label">Category Filter</label>
                            <select class="form-select category-select" data-level="0" id="category-filter">
                                <option value="">Select a category filter</option>
                            </select>
                        </div>
                        <div class="category-level mb-3" data-level="1" style="display: none;">
                            <label class="form-label">Category</label>
                            <select class="form-select category-select" data-level="1" id="category">
                                <option value="">Select a category</option>
                            </select>
                        </div>
                    `;
                    
                    // Add to container
                    categoryContainer.append(filterSelect);
                    
                    // Add filter options
                    const filterSelectElement = $('#category-filter');
                    filters.forEach(function(filter) {
                        filterSelectElement.append(new Option(filter.name, `filter_${filter.id}`, false, false));
                    });
                    
                    // If there's a selected filter in the URL or form, pre-select it
                    {% if form.categories.value %}
                        const selectedId = '{{ form.categories.value }}';
                        const category = {{ form.categories.value|default:'null' }};
                        if (category) {
                            // Find the filter that contains this category
                            const filter = filters.find(f => 
                                f.categories.some(cat => cat.id.toString() === selectedId)
                            );
                            if (filter) {
                                $(`#category-filter`).val(`filter_${filter.id}`).trigger('change');
                                // The category will be selected after the categories are loaded
                                setTimeout(() => {
                                    $('#category').val(selectedId);
                                    updateCategoryPath();
                                }, 100);
                            }
                        }
                    {% endif %}
                } else {
                    categoryContainer.append('<div class="alert alert-warning">No category filters found.</div>');
                }
            })
            .fail(function(xhr, status, error) {
                $(`#${loadingId}`).text('Error loading category filters: ' + error);
                console.error('Error loading category filters:', error);
            });
    }
    
    // Function to load categories for a specific filter
    function loadCategories(level, filterId) {
        const url = '{% url "vendor:get_categories" %}';
        const loadingId = 'category-loading';
        
        // Show loading state
        $(`#${loadingId}`).remove();
        $(`#category`).parent().after(`<div id="${loadingId}" class="text-muted small mb-2">Loading categories...</div>`);

        // Make AJAX request to get categories for the selected filter
        $.getJSON(`${url}?filter_id=${filterId}`)
            .done(function(categories) {
                // Remove loading indicator
                $(`#${loadingId}`).remove();
                
                // Get the category select element
                const categorySelect = $('#category');
                categorySelect.empty().append('<option value="">Select a category</option>');
                
                if (categories && categories.length > 0) {
                    categories.forEach(function(category) {
                        categorySelect.append(new Option(
                            category.name, 
                            category.id, 
                            false, 
                            category.id.toString() === selectedCategory.val()
                        ));
                    });
                    categorySelect.parent().show();
                } else {
                    categorySelect.parent().hide();
                }
                
                // Update the selected category if needed
                if (selectedCategories.length > 1 && selectedCategories[1]) {
                    const selectedId = selectedCategories[1].id.toString();
                    if (categorySelect.find(`option[value="${selectedId}"]`).length) {
                        categorySelect.val(selectedId);
                    }
                }
            })
            .fail(function(xhr, status, error) {
                $(`#${loadingId}`).text('Error loading categories: ' + error);
                console.error('Error loading categories:', error);
            });
    }
});
</script>

<script>
$(document).ready(function() {
    // Add form validation
    $('form').on('submit', function(e) {
        var isValid = true;
        
        // Check required fields
        $('input[required], select[required], textarea[required]').each(function() {
            if (!$(this).val()) {
                $(this).addClass('is-invalid');
                isValid = false;
            } else {
                $(this).removeClass('is-invalid');
            }
        });
        
        if (!isValid) {
            e.preventDefault();
            alert('Please fill in all required fields.');
        }
    });
    
    // Remove validation classes on input
    $('input, select, textarea').on('input change', function() {
        $(this).removeClass('is-invalid');
    });

    // Hide/show Single Unit Price when MOQ == 1
    function toggleSinglePrice() {
        var moqVal = parseInt($('#id_moq').val() || '1', 10);
        if (!isNaN(moqVal) && moqVal > 1) {
            $('#single-price-wrapper').show();
        } else {
            $('#single-price-wrapper').hide();
        }
    }
    toggleSinglePrice();
    $('#id_moq').on('input change', toggleSinglePrice);
});
</script>
{% endblock %}
