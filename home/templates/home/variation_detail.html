{% extends 'users/base.html' %}
{% load static %}

{% block extra_css %}
{{ block.super }}
<style>
/* Chat Button Styles */
.chat-button {
    position: fixed;
    bottom: 2rem;
    right: 2rem;
    width: 60px;
    height: 60px;
    border-radius: 50%;
    background-color: #4F46E5;
    color: white;
    border: none;
    box-shadow: 0 4px 12px rgba(0, 0, 0, 0.15);
    cursor: pointer;
    display: flex;
    align-items: center;
    justify-content: center;
    z-index: 1000;
    transition: all 0.3s ease;
}

.chat-button:hover {
    background-color: #4338CA;
    transform: translateY(-2px);
    box-shadow: 0 6px 16px rgba(0, 0, 0, 0.2);
}

.chat-button i {
    font-size: 24px;
}

/* Chat Container */
.chat-container {
    position: fixed;
    bottom: 5.5rem;
    right: 2rem;
    width: 350px;
    max-width: 90vw;
    height: 500px;
    max-height: 70vh;
    background: white;
    border-radius: 12px;
    box-shadow: 0 10px 25px rgba(0, 0, 0, 0.2);
    display: flex;
    flex-direction: column;
    overflow: hidden;
    z-index: 1001;
    transform: translateY(20px);
    opacity: 0;
    visibility: hidden;
    transition: all 0.3s ease-in-out;
}

.chat-container.open {
    transform: translateY(0);
    opacity: 1;
    visibility: visible;
}

/* Chat Header */
.chat-header {
    background: #4F46E5;
    color: white;
    padding: 1rem 1.25rem;
    display: flex;
    justify-content: space-between;
    align-items: center;
}

.chat-header h3 {
    margin: 0;
    font-size: 1.1rem;
    font-weight: 600;
}

.close-chat {
    background: none;
    border: none;
    color: white;
    font-size: 1.25rem;
    cursor: pointer;
    padding: 0.25rem;
    line-height: 1;
}

/* Chat Messages */
.chat-messages {
    flex: 1;
    padding: 1.25rem;
    overflow-y: auto;
    background: #f8fafc;
    display: flex;
    flex-direction: column;
    gap: 0.75rem;
}

.message {
    max-width: 80%;
    padding: 0.75rem 1rem;
    border-radius: 1rem;
    line-height: 1.4;
    font-size: 0.9rem;
    position: relative;
}

.message.user {
    align-self: flex-end;
    background: #4F46E5;
    color: white;
    border-bottom-right-radius: 0.25rem;
}

.message.bot {
    align-self: flex-start;
    background: white;
    color: #1e293b;
    border: 1px solid #e2e8f0;
    border-bottom-left-radius: 0.25rem;
}

/* Chat Input */
.chat-input-container {
    padding: 1rem;
    border-top: 1px solid #e2e8f0;
    background: white;
    display: flex;
    gap: 0.5rem;
}

.chat-input {
    flex: 1;
    padding: 0.75rem 1rem;
    border: 1px solid #e2e8f0;
    border-radius: 1.5rem;
    font-size: 0.9rem;
    outline: none;
    transition: border-color 0.2s;
}

.chat-input:focus {
    border-color: #4F46E5;
}

.send-button {
    background: #4F46E5;
    color: white;
    border: none;
    border-radius: 50%;
    width: 42px;
    height: 42px;
    min-width: 42px;
    display: flex;
    align-items: center;
    justify-content: center;
    cursor: pointer;
    transition: background-color 0.2s ease;
}

.send-button:hover {
    background: #4338CA;
}

.send-button:active {
    transform: scale(0.95);
}

.send-button i {
    font-size: 1.1rem;
}

#promiseFeeModal {
    display: none;
    position: fixed;
    top: 0;
    left: 0;
    right: 0;
    bottom: 0;
    background-color: rgba(0, 0, 0, 0.5);
    z-index: 1000;
    align-items: center;
    justify-content: center;
    padding: 1rem;
  }

  #promiseFeeModal[style*="display: flex"] {
    display: flex !important;
  }

  .promise-fee-modal-content {
    background: white;
    border-radius: 0.5rem;
    max-width: 500px;
    width: 100%;
    max-height: 90vh;
    overflow-y: auto;
    box-shadow: 0 20px 25px -5px rgba(0, 0, 0, 0.1), 0 10px 10px -5px rgba(0, 0, 0, 0.04);
  }

  .promise-fee-modal-header {
    padding: 1.25rem 1.5rem;
    border-bottom: 1px solid #e5e7eb;
    display: flex;
    align-items: center;
    justify-content: space-between;
  }

  .promise-fee-modal-body {
    padding: 1.5rem;
  }

  .promise-fee-modal-close {
    color: #6b7280;
    background: none;
    border: none;
    font-size: 1.5rem;
    cursor: pointer;
    line-height: 1;
    padding: 0.25rem;
  }

  .promise-fee-modal-close:hover {
    color: #374151;
  }

  .promise-fee-feature-list {
    list-style-type: none;
    padding: 0;
    margin: 1.5rem 0;
  }

  .promise-fee-feature-list li {
    padding: 0.5rem 0;
    display: flex;
    align-items: flex-start;
    gap: 0.75rem;
  }

  .promise-fee-feature-list li:before {
    content: "✓";
    color: #10b981;
    font-weight: bold;
    flex-shrink: 0;
    margin-top: 0.25rem;
  }



  @keyframes typing {

    0%,
    100% {
      opacity: 0.4;
      transform: translateY(0);
    }

    50% {
      opacity: 1;
      transform: translateY(-3px);
    }
  }

  /* Message styles */
  .message {
    max-width: 80%;
    padding: 10px 15px;
    border-radius: 18px;
    line-height: 1.4;
    position: relative;
    word-wrap: break-word;
  }

  .user-message {
    align-self: flex-end;
    background-color: #4a6cf7;
    color: white;
    border-bottom-right-radius: 4px;
  }

  .assistant-message {
    align-self: flex-start;
    background-color: #f1f3f5;
    color: #212529;
    border-bottom-left-radius: 4px;
  }

  /* Line clamp for product names */
  .line-clamp-2 {
    display: -webkit-box;
    line-clamp: 2;
    -webkit-line-clamp: 2;
    -webkit-box-orient: vertical;
    overflow: hidden;
  }

  /* Promise Fee Modal */
  #promiseFeeModal {
    display: none;
    position: fixed;
    top: 0;
    left: 0;
    right: 0;
    bottom: 0;
    background-color: rgba(0, 0, 0, 0.5);
    z-index: 1000;
    align-items: center;
    justify-content: center;
    padding: 1rem;
  }

  #promiseFeeModal[style*="display: flex"] {
    display: flex !important;
  }

  .promise-fee-modal-content {
    background: white;
    padding: 1.5rem;
    border-radius: 0.5rem;
    max-width: 500px;
    width: 90%;
    max-height: 90vh;
    overflow-y: auto;
  }

  /* Payment Plan Slider Styles */
  .slider {
    -webkit-appearance: none;
    appearance: none;
    background: transparent;
    cursor: pointer;
  }

  .slider::-webkit-slider-track {
    background: #e5e7eb;
    height: 8px;
    border-radius: 4px;
  }

  .slider::-webkit-slider-thumb {
    -webkit-appearance: none;
    appearance: none;
    background: #3b82f6;
    height: 20px;
    width: 20px;
    border-radius: 50%;
    cursor: pointer;
    box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
    transition: all 0.2s ease;
  }

  .slider::-webkit-slider-thumb:hover {
    background: #2563eb;
    transform: scale(1.1);
  }

  .slider::-moz-range-track {
    background: #e5e7eb;
    height: 8px;
    border-radius: 4px;
    border: none;
  }

  .slider::-moz-range-thumb {
    background: #3b82f6;
    height: 20px;
    width: 20px;
    border-radius: 50%;
    cursor: pointer;
    border: none;
    box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
    transition: all 0.2s ease;
  }

  .slider::-moz-range-thumb:hover {
    background: #2563eb;
    transform: scale(1.1);
  }

  /* Payment plan animation */
  .payment-plan-transition {
    transition: all 0.3s ease-in-out;
  }
</style>

<script>
// Payment Plan Variables - Define globally
let currentVariationPrice = 0;
let currentQuantity = 1;
let isPaymentPlanEnabled = false;

// Payment Plan Functions - Make them globally accessible immediately
window.togglePaymentPlan = function() {
    const checkbox = document.getElementById('enable-payment-plan');
    const paymentPlanDetails = document.getElementById('payment-plan-details');
    const addToCartBtn = document.getElementById('add-to-cart-btn');
    
    if (!checkbox || !paymentPlanDetails || !addToCartBtn) {
        console.error('Payment plan elements not found');
        return;
    }
    
    isPaymentPlanEnabled = checkbox.checked;
    
    if (isPaymentPlanEnabled) {
        paymentPlanDetails.classList.remove('hidden');
        paymentPlanDetails.classList.add('payment-plan-transition');
        addToCartBtn.textContent = 'Add to Cart with Payment Plan';
        addToCartBtn.classList.remove('bg-blue-600', 'hover:bg-blue-700');
        addToCartBtn.classList.add('bg-green-600', 'hover:bg-green-700');
        
        // Initialize payment plan calculations
        window.updatePaymentPlan();
    } else {
        paymentPlanDetails.classList.add('hidden');
        addToCartBtn.textContent = 'Add to Cart';
        addToCartBtn.classList.remove('bg-green-600', 'hover:bg-green-700');
        addToCartBtn.classList.add('bg-blue-600', 'hover:bg-blue-700');
    }
};

window.updatePaymentPlan = function() {
    if (!isPaymentPlanEnabled) return;
    
    const slider = document.getElementById('payment-slider');
    if (!slider) return;
    
    const percentage = parseInt(slider.value);
    
    // Update quantity from the form
    const quantityInput = document.querySelector('input[name="quantity"]');
    currentQuantity = parseInt(quantityInput.value) || 1;
    
    // Calculate total cost
    const totalCost = currentVariationPrice * currentQuantity;
    
    // Calculate payment amounts
    const payNowAmount = (totalCost * percentage / 100);
    const payLaterAmount = totalCost - payNowAmount;
    const payLaterPercentage = 100 - percentage;
    
    // Update display elements
    const elements = {
        'payment-percentage': percentage + '%',
        'pay-now-percent': percentage,
        'pay-later-percent': payLaterPercentage,
        'total-cost': 'Ksh' + totalCost.toFixed(2),
        'pay-now-amount': 'Ksh' + payNowAmount.toFixed(2),
        'pay-later-amount': 'Ksh' + payLaterAmount.toFixed(2),
        'remaining-balance': 'Ksh' + payLaterAmount.toFixed(2)
    };
    
    for (const [id, value] of Object.entries(elements)) {
        const element = document.getElementById(id);
        if (element) {
            element.textContent = value;
        }
    }
    
    // Add payment plan data to form
    addPaymentPlanDataToForm(percentage, payNowAmount, payLaterAmount);
};

function addPaymentPlanDataToForm(percentage, payNowAmount, payLaterAmount) {
    // Remove existing payment plan inputs
    const existingInputs = document.querySelectorAll('input[name^="payment_plan_"]');
    existingInputs.forEach(input => input.remove());
    
    if (isPaymentPlanEnabled) {
        const form = document.querySelector('form[action*="add_to_cart"]');
        if (!form) return;
        
        // Add payment plan data as hidden inputs
        const percentageInput = document.createElement('input');
        percentageInput.type = 'hidden';
        percentageInput.name = 'payment_plan_percentage';
        percentageInput.value = percentage;
        form.appendChild(percentageInput);
        
        const payNowInput = document.createElement('input');
        payNowInput.type = 'hidden';
        payNowInput.name = 'payment_plan_pay_now';
        payNowInput.value = payNowAmount.toFixed(2);
        form.appendChild(payNowInput);
        
        const payLaterInput = document.createElement('input');
        payLaterInput.type = 'hidden';
        payLaterInput.name = 'payment_plan_pay_later';
        payLaterInput.value = payLaterAmount.toFixed(2);
        form.appendChild(payLaterInput);
        
        const enabledInput = document.createElement('input');
        enabledInput.type = 'hidden';
        enabledInput.name = 'payment_plan_enabled';
        enabledInput.value = 'true';
        form.appendChild(enabledInput);
    }
}

// Initialize payment plan when page loads
document.addEventListener('DOMContentLoaded', function() {
    // Set the current variation price
    currentVariationPrice = parseFloat('{{ variation.price|floatformat:2 }}') || 0;
    currentQuantity = {{ variation.moq|default:1 }};
    
    // Set up quantity change listener
    const quantityInput = document.querySelector('input[name="quantity"]');
    if (quantityInput) {
        quantityInput.addEventListener('input', function() {
            if (isPaymentPlanEnabled) {
                window.updatePaymentPlan();
            }
        });
    }
    
    // Initialize payment plan on page load
    window.updatePaymentPlan();
});
</script>
{% endblock %}

{% block title %}{{ product.name }} – {{ variation.name }} - WholeSaleHub{% endblock %}

{% block content %}
<!-- Add data attributes for chat initialization -->
<div data-product-id="{{ product.id }}" data-variation-id="{{ variation.id }}" id="chat-data"></div>
<!-- Breadcrumb -->
<div class="bg-white border-b border-gray-200 py-3">
  <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8">
    <nav class="flex" aria-label="Breadcrumb">
      <ol class="flex items-center space-x-3">
        <li>
          <div>
            <a href="{% url 'home:home' %}" class="text-gray-400 hover:text-gray-500">
              <svg class="flex-shrink-0 h-5 w-5" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 20 20" fill="currentColor" aria-hidden="true">
                <path d="M10.707 2.293a1 1 0 00-1.414 0l-7 7a1 1 0 001.414 1.414L4 10.414V17a1 1 0 001 1h2a1 1 0 001-1v-2a1 1 0 011-1h2a1 1 0 011 1v2a1 1 0 001 1h2a1 1 0 001-1v-6.586l.293.293a1 1 0 001.414-1.414l-7-7z" />
              </svg>
              <span class="sr-only">Home</span>
            </a>
          </div>
        </li>
        <li>
          <div class="flex items-center">
            <svg class="flex-shrink-0 h-5 w-5 text-gray-300" xmlns="http://www.w3.org/2000/svg" fill="currentColor" viewBox="0 0 20 20" aria-hidden="true">
              <path d="M5.555 17.776l8-16 .894.448-8 16-.894-.448z" />
            </svg>
            <a href="{% url 'home:product_list' %}" class="ml-3 text-sm font-medium text-blue-600 hover:text-blue-700">Products</a>
          </div>
        </li>
        <li>
          <div class="flex items-center">
            <svg class="flex-shrink-0 h-5 w-5 text-gray-300" xmlns="http://www.w3.org/2000/svg" fill="currentColor" viewBox="0 0 20 20" aria-hidden="true">
              <path d="M5.555 17.776l8-16 .894.448-8 16-.894-.448z" />
            </svg>
            <a href="{% url 'home:product_detail' product.pk %}" class="ml-3 text-sm font-medium text-blue-600 hover:text-blue-700">{{ product.name|truncatechars:30 }}</a>
          </div>
        </li>
        <li>
          <div class="flex items-center">
            <svg class="flex-shrink-0 h-5 w-5 text-gray-300" xmlns="http://www.w3.org/2000/svg" fill="currentColor" viewBox="0 0 20 20" aria-hidden="true">
              <path d="M5.555 17.776l8-16 .894.448-8 16-.894-.448z" />
            </svg>
            <span class="ml-3 text-sm font-medium text-gray-500">{{ variation.name|truncatechars:30 }}</span>
          </div>
        </li>
      </ol>
    </nav>
  </div>
</div>

<div class="max-w-7xl mx-auto px-4 py-8">
  <div class="grid lg:grid-cols-2 gap-8 items-start">
    <!-- Images -->
    <div class="lg:sticky lg:top-0 lg:self-start">
      {% if images %}
      <div class="mb-4">
        <img src="{{ images.first.image.url }}" alt="{{ product.name }} – {{ variation.name }}"
          class="w-full h-96 object-cover rounded-lg shadow-lg" id="main-image">
      </div>
      {% if images.count > 1 %}
      <div class="grid grid-cols-4 gap-2">
        {% for image in images %}
        <img src="{{ image.image.url }}" alt="{{ product.name }} – {{ variation.name }}"
          class="w-full h-20 object-cover rounded-lg cursor-pointer hover:opacity-75 transition-opacity"
          onclick="changeMainImage('{{ image.image.url }}')">
        {% endfor %}
      </div>
      {% endif %}
      {% else %}
      <div class="w-full h-96 bg-gray-200 rounded-lg flex items-center justify-center">
        <svg class="w-24 h-24 text-gray-400" fill="none" stroke="currentColor" viewBox="0 0 24 24">
          <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
            d="M4 16l4.586-4.586a2 2 0 012.828 0L16 16m-2-2l1.586-1.586a2 2 0 012.828 0L20 14m-6-6h.01M6 20h12a2 2 0 002-2V6a2 2 0 00-2-2H6a2 2 0 00-2 2v12a2 2 0 002 2z" />
        </svg>
      </div>
      {% endif %}
    </div>

    <!-- Details -->
    <div>
      <h1 class="text-3xl font-bold text-gray-900 mb-2">{{ product.name }}</h1>
      <div class="flex flex-col sm:flex-row sm:items-center gap-2 text-gray-600 mb-6">
        <div>Variation: <span class="font-semibold text-gray-900">{{ variation.name }}</span></div>
        {% if variations_count > 1 %}
        <span class="hidden sm:inline">•</span>
        <div class="text-sm bg-blue-50 text-blue-700 px-2 py-1 rounded-full">
          {{ variations_count }} variation{{ variations_count|pluralize }} available
        </div>
        {% endif %}
      </div>

      <!-- Vendor Info -->
      <div class="flex items-center justify-between mb-4">
        <div class="flex items-center">
          <div class="w-10 h-10 bg-blue-100 rounded-full flex items-center justify-center mr-3">
            <svg class="w-6 h-6 text-blue-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                d="M19 21V5a2 2 0 00-2-2H7a2 2 0 00-2 2v16m14 0h2m-2 0h-5m-9 0H3m2 0h5M9 7h1m-1 4h1m4-4h1m-1 4h1m-5 10v-5a1 1 0 011-1h2a1 1 0 011 1v5m-4 0h4" />
            </svg>
          </div>
          <div>
            <p class="text-sm text-gray-600">Sold by</p>
            <p class="font-semibold text-gray-900">{{ product.business.name }}</p>
          </div>
        </div>
        <div class="flex space-x-3">
          <button onclick="openOrderModal()"
            class="inline-flex items-center px-4 py-2 border border-transparent text-sm font-medium rounded-md shadow-sm text-white bg-blue-600 hover:bg-blue-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-blue-500 transition-colors">
            <svg class="-ml-1 mr-2 h-5 w-5" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke="currentColor">
              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M3 3h2l.4 2M7 13h10l4-8H5.4M7 13L5.4 5M7 13l-2.293 2.293c-.63.63-.184 1.707.707 1.707H17m0 0a2 2 0 100 4 2 2 0 000-4zm-8 2a2 2 0 11-4 0 2 2 0 014 0z" />
            </svg>
            Start Order
          </button>
          <!-- Inline Chat buttons removed; now provided under radial FAB -->
        </div>
      </div>

      <!-- Price & MOQ -->
      <div class="bg-gray-50 rounded-lg p-6 mb-6">
        <div class="flex items-center justify-between">
          <div>
            <div class="text-gray-500 text-sm">Unit price</div>
            <div class="text-4xl font-bold text-blue-600">Ksh {{ variation.price }}</div>
          </div>
          <span class="text-sm text-gray-500 bg-white px-3 py-1 rounded-full">
            {% with cats=product.categories.all %}
            {% if cats %}
            {% for c in cats %}{{ c.name }}{% if not forloop.last %}, {% endif %}{% endfor %}
            {% endif %}
            {% endwith %}
          </span>
        </div>
        <div class="flex items-center justify-between text-sm text-gray-600 mt-4">
          <span>Minimum Order Quantity (MOQ):</span>
          <span class="font-semibold">{{ variation.moq }} units</span>
        </div>
      </div>

      {% if price_tiers %}
      <!-- Bulk Pricing -->
      <div class="bg-white rounded-lg border border-gray-200 p-6 mb-6">
        <h3 class="text-lg font-semibold text-gray-900 mb-3">Bulk Pricing</h3>
        <div class="overflow-x-auto">
          <table class="min-w-full text-left text-sm">
            <thead>
              <tr class="text-gray-500">
                <th class="py-2 pr-4">Quantity Range</th>
                <th class="py-2 pr-4">Unit Price</th>
              </tr>
            </thead>
            <tbody class="divide-y divide-gray-100">
              {% for t in price_tiers %}
              <tr>
                <td class="py-2 pr-4 text-gray-700">
                  {{ t.min_quantity }}
                  {% if t.max_quantity %}
                    - {{ t.max_quantity }}
                  {% else %}
                    +
                  {% endif %}
                </td>
                <td class="py-2 pr-4 font-semibold text-gray-900">Ksh {{ t.price|floatformat:2 }}</td>
              </tr>
              {% endfor %}
            </tbody>
          </table>
        </div>
      </div>
      {% endif %}

      <!-- Product Attributes -->
      {% if has_attributes %}
      <div class="bg-white rounded-lg shadow p-6 mb-6">
        <h3 class="text-lg font-semibold text-gray-900 mb-4">Product Specifications</h3>
        <div class="space-y-4">
          {% for attr_name, values in attribute_groups.items %}
          <div class="border-b border-gray-100 pb-3 last:border-0 last:pb-0">
            <dt class="text-sm font-medium text-gray-500">{{ attr_name }}</dt>
            <dd class="mt-1 text-sm text-gray-900">
              {% for value in values %}
              <span
                class="inline-block bg-gray-100 rounded-full px-3 py-1 text-sm font-semibold text-gray-700 mr-2 mb-2">
                {{ value }}
              </span>
              {% endfor %}
            </dd>
          </div>
          {% endfor %}
        </div>
      </div>
      {% endif %}

      <!-- Additional Fees -->
      {% if additional_fees %}
      <div class="bg-white rounded-lg shadow p-6 mb-6">
        <h3 class="text-lg font-semibold text-gray-900 mb-4 flex items-center">
          <svg class="w-5 h-5 mr-2 text-green-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M17 9V7a2 2 0 00-2-2H5a2 2 0 00-2 2v6a2 2 0 002 2h2m2 4h10a2 2 0 002-2v-6a2 2 0 00-2-2H9a2 2 0 00-2 2v6a2 2 0 002 2zm7-5a2 2 0 11-4 0 2 2 0 014 0z"/>
          </svg>
          Additional Fees
        </h3>
        <div class="space-y-4">
          {% for fee in additional_fees %}
          <div class="flex items-start justify-between p-4 bg-green-50 rounded-lg border border-green-100 hover:shadow-md transition-shadow">
            <div class="flex items-start">
              <div class="flex-shrink-0 h-10 w-10 rounded-full bg-green-100 flex items-center justify-center mr-4">
                <svg class="h-5 w-5 text-green-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                  <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 8c-1.657 0-3 .895-3 2s1.343 2 3 2 3 .895 3 2-1.343 2-3 2m0-8c1.11 0 2.08.402 2.599 1M12 8V7m0 1v8m0 0v1m0-1c-1.11 0-2.08-.402-2.599-1"/>
                </svg>
              </div>
              <div>
                <h4 class="text-sm font-medium text-gray-900 flex items-center">
                  {{ fee.name }}
                  {% if fee.is_required %}
                  <span class="ml-2 px-2 py-1 text-xs font-medium bg-red-100 text-red-800 rounded-full">Required</span>
                  {% endif %}
                </h4>
                {% if fee.description %}
                <p class="text-sm text-gray-600 mt-1">{{ fee.description }}</p>
                {% endif %}
                <p class="text-xs text-gray-500 mt-1">
                  <span class="font-medium">Applies to:</span>
                  {% for var in fee.variation.all %}
                    {{ var.name }}{% if not forloop.last %}, {% endif %}
                  {% endfor %}
                </p>
              </div>
            </div>
            <div class="text-right">
              <div class="text-lg font-semibold text-green-600">KSh {{ fee.price|floatformat:2 }}</div>
              <div class="text-xs text-gray-500">per item</div>
            </div>
          </div>
          {% endfor %}
        </div>
      </div>
      {% endif %}

      <!-- Purchase -->
      <div class="bg-white rounded-lg shadow p-6 mb-6">
        <form method="post" action="{% url 'home:add_to_cart' %}" class="space-y-4">
          {% csrf_token %}
          <input type="hidden" name="product_id" value="{{ product.id }}" />
          <input type="hidden" name="variation_id" value="{{ variation.id }}" />
          <input type="hidden" name="next" value="{{ request.get_full_path }}" />
          <div>
            <label class="block text-sm font-medium text-gray-700 mb-2">Quantity</label>
            <div class="flex items-center">
              <input name="quantity" type="number" min="{{ variation.moq }}" value="{{ variation.moq }}"
                class="w-28 border border-gray-300 rounded-lg px-3 py-2 focus:outline-none focus:ring-2 focus:ring-blue-500" />
              <span class="ml-3 text-sm text-gray-500">units (MOQ {{ variation.moq }})</span>
            </div>
          </div>

          <!-- Payment Plan Selection -->
          <div class="border-t border-gray-200 pt-4">
            <div class="flex items-center justify-between mb-4">
              <h3 class="text-lg font-medium text-gray-900">Payment Options</h3>
              <div class="flex items-center">
                <input type="checkbox" id="enable-payment-plan" class="h-4 w-4 text-blue-600 focus:ring-blue-500 border-gray-300 rounded" onchange="togglePaymentPlan()">
                <label for="enable-payment-plan" class="ml-2 text-sm text-gray-700">Use Payment Plan</label>
              </div>
            </div>

            <!-- Payment Plan Details -->
            <div id="payment-plan-details" class="hidden space-y-4">
              <div class="bg-gray-50 rounded-lg p-4">
                <div class="flex items-center justify-between mb-3">
                  <span class="text-sm font-medium text-gray-700">Pay Now Percentage</span>
                  <span id="payment-percentage" class="text-lg font-bold text-blue-600">50%</span>
                </div>
                
                <!-- Percentage Slider -->
                <div class="relative">
                  <input type="range" 
                         id="payment-slider" 
                         min="10" 
                         max="100" 
                         value="50" 
                         step="5"
                         class="w-full h-2 bg-gray-200 rounded-lg appearance-none cursor-pointer slider"
                         oninput="updatePaymentPlan()">
                  <div class="flex justify-between text-xs text-gray-500 mt-1">
                    <span>10%</span>
                    <span>25%</span>
                    <span>50%</span>
                    <span>75%</span>
                    <span>100%</span>
                  </div>
                </div>

                <!-- Payment Breakdown -->
                <div class="mt-4 space-y-2">
                  <div class="flex justify-between text-sm">
                    <span class="text-gray-600">Total Cost:</span>
                    <span id="total-cost" class="font-medium">Ksh 0.00</span>
                  </div>
                  <div class="flex justify-between text-sm">
                    <span class="text-gray-600">Pay Now (<span id="pay-now-percent">50</span>%):</span>
                    <span id="pay-now-amount" class="font-medium text-blue-600">Ksh 0.00</span>
                  </div>
                  <div class="flex justify-between text-sm">
                    <span class="text-gray-600">Pay Later (<span id="pay-later-percent">50</span>%):</span>
                    <span id="pay-later-amount" class="font-medium text-gray-500">Ksh 0.00</span>
                  </div>
                  <div class="border-t border-gray-200 pt-2">
                    <div class="flex justify-between text-sm font-medium">
                      <span class="text-gray-900">Remaining Balance:</span>
                      <span id="remaining-balance" class="text-gray-900">Ksh 0.00</span>
                    </div>
                  </div>
                </div>
              </div>

              <!-- Payment Plan Benefits -->
              <div class="bg-blue-50 rounded-lg p-4">
                <h4 class="text-sm font-medium text-blue-900 mb-2">Payment Plan Benefits</h4>
                <ul class="text-xs text-blue-800 space-y-1">
                  <li>• Secure your order with a partial payment</li>
                  <li>• Flexible payment schedule</li>
                  <li>• No additional fees for payment plans</li>
                  <li>• Easy balance management</li>
                </ul>
              </div>
            </div>
          </div>

          <div>
            {% if in_cart %}
            <button type="button" disabled class="w-full bg-green-50 text-green-700 py-3 px-6 rounded-lg font-semibold">
              <svg class="w-5 h-5 inline mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 13l4 4L19 7" />
              </svg>
              In cart
            </button>
            {% else %}
            <button type="submit" id="add-to-cart-btn"
              class="w-full bg-blue-600 text-white py-3 px-6 rounded-lg font-semibold hover:bg-blue-700 transition-colors">
              Add to Cart
            </button>
            {% endif %}
          </div>
        </form>
        <a href="{% url 'home:product_detail' product.pk %}"
          class="block text-center text-sm text-blue-600 hover:text-blue-800 mt-3">Back to product page</a>
      </div>

      <!-- Description -->
      {% if product.description %}
      <div class="mb-6">
        <h3 class="text-lg font-semibold text-gray-900 mb-3">Description</h3>
        <p class="text-gray-700 leading-relaxed">{{ product.description|linebreaks }}</p>
      </div>
      {% endif %}
    </div>
  </div>

  <!-- Related Products -->
  {% if related_products %}
  <div class="mt-16">
    <h2 class="text-2xl font-bold text-gray-900 mb-6">Related Products</h2>
    <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-6">
      {% for related_product in related_products %}
      <div class="bg-white rounded-lg shadow-md hover:shadow-lg transition-shadow duration-300 overflow-hidden">
        <div class="aspect-w-16 aspect-h-12 bg-gray-200">
          {% if related_product.images.first %}
          <img src="{{ related_product.images.first.image.url }}" alt="{{ related_product.name }}"
            class="w-full h-48 object-cover" />
          {% else %}
          <div class="w-full h-48 bg-gray-200 flex items-center justify-center">
            <svg class="w-16 h-16 text-gray-400" fill="none" stroke="currentColor" viewBox="0 0 24 24">
              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                d="M4 16l4.586-4.586a2 2 0 012.828 0L16 16m-2-2l1.586-1.586a2 2 0 012.828 0L20 14m-6-6h.01M6 20h12a2 2 0 002-2V6a2 2 0 00-2-2H6a2 2 0 00-2 2v12a2 2 0 002 2z" />
            </svg>
          </div>
          {% endif %}
        </div>
        <div class="p-4">
          <h3 class="text-lg font-semibold text-gray-900 mb-2 line-clamp-2">{{ related_product.name }}</h3>
          <p class="text-sm text-gray-600 mb-2">{{ related_product.business.name }}</p>
          <div class="flex items-center justify-between mb-3">
            <span class="text-xl font-bold text-blue-600">MOQ: {{ related_product.moq }}</span>
          </div>
          <a href="{% url 'home:product_detail' related_product.pk %}"
            class="w-full bg-blue-600 text-white py-2 px-4 rounded-lg text-sm hover:bg-blue-700 transition-colors text-center block">
            View Details
          </a>
        </div>
      </div>
      {% endfor %}
    </div>
  </div>
  {% endif %}
</div>

<!-- AI Chat Container -->
<div id="aiChatContainer" class="fixed bottom-4 right-4 w-80 h-96 bg-white rounded-lg shadow-lg border border-gray-200 z-50 hidden flex flex-col">
    <div class="bg-purple-600 text-white p-4 rounded-t-lg flex justify-between items-center">
        <h3 class="text-lg font-semibold">AI Assistant</h3>
        <button id="aiCloseButton" class="text-white hover:text-gray-200">
            <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"></path>
            </svg>
        </button>
    </div>
    
    <div id="aiChatMessages" class="flex-1 p-4 overflow-y-auto bg-gray-50">
        <div class="message bot mb-4">
            <div class="bg-white rounded-lg p-3 shadow-sm">
                <p class="text-sm text-gray-700">Hello! I'm your AI assistant. I can help you with questions about this product, pricing, specifications, and more. How can I assist you today?</p>
            </div>
        </div>
    </div>
    
    <div id="aiTypingIndicator" class="hidden p-4 bg-gray-50">
        <div class="flex items-center space-x-2">
            <div class="flex space-x-1">
                <div class="w-2 h-2 bg-gray-400 rounded-full animate-bounce"></div>
                <div class="w-2 h-2 bg-gray-400 rounded-full animate-bounce" style="animation-delay: 0.1s"></div>
                <div class="w-2 h-2 bg-gray-400 rounded-full animate-bounce" style="animation-delay: 0.2s"></div>
            </div>
            <span class="text-sm text-gray-500">AI is typing...</span>
        </div>
    </div>
    
    <div class="p-4 border-t border-gray-200">
        <div class="flex space-x-2">
            <input type="text" id="aiChatInput" placeholder="Ask me anything about this product..." 
                   class="flex-1 px-3 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-purple-500 focus:border-transparent">
            <button id="aiSendButton" class="px-4 py-2 bg-purple-600 text-white rounded-lg hover:bg-purple-700 focus:outline-none focus:ring-2 focus:ring-purple-500">
                <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 19l9 2-9-18-9 18 9-2zm0 0v-8"></path>
                </svg>
            </button>
        </div>
    </div>
    
    <div id="aiUnreadBadge" class="absolute -top-2 -right-2 bg-red-500 text-white text-xs rounded-full w-6 h-6 flex items-center justify-center hidden">
        <span>1</span>
    </div>
</div>

{% block extra_js %}
{{ block.super }}
<script src="{% static 'js/chat.js' %}"></script>
<script>
// Initialize AI Chat when page loads
document.addEventListener('DOMContentLoaded', function() {
    // Get product and variation IDs from the data attributes
    const chatData = document.getElementById('chat-data');
    if (chatData) {
        const productId = chatData.getAttribute('data-product-id');
        const variationId = chatData.getAttribute('data-variation-id');
        
        // Initialize the AI chat
        if (window.ProductChat && productId && variationId) {
            window.aiChat = new ProductChat({
                productId: productId,
                variationId: variationId,
                chatButtonId: 'aiChatButton',
                chatContainerId: 'aiChatContainer',
                chatMessagesId: 'aiChatMessages',
                chatInputId: 'aiChatInput',
                sendButtonId: 'aiSendButton',
                closeButtonId: 'aiCloseButton',
                typingIndicatorId: 'aiTypingIndicator',
                unreadBadgeId: 'aiUnreadBadge'
            });
        }
    }
});

// Image gallery functionality
  function changeMainImage(url) {
    var img = document.getElementById('main-image');
    if (img) img.src = url;
  }
</script>
  {% endblock %}

<!-- Order Quantity Modal -->
<div id="orderModal" class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50 px-4 py-6" style="display: none;">
    <div class="bg-white rounded-lg shadow-xl max-w-md w-full max-h-[90vh] overflow-y-auto">
        <div class="p-6">
            <div class="flex justify-between items-center mb-4">
                <h3 class="text-xl font-semibold text-gray-900">Order Quantity</h3>
                <button type="button" onclick="closeOrderModal()" class="text-gray-400 hover:text-gray-500">
                    <span class="sr-only">Close</span>
                    <svg class="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12" />
                    </svg>
                </button>
            </div>
            
            <div class="mt-4">
                <!-- Product Info -->
                <div class="flex items-start mb-6 pb-4 border-b border-gray-100">
                    <div class="flex-shrink-0 w-20 h-20 bg-gray-100 rounded-md overflow-hidden">
                        <img src="{{ variation.image.url|default:product.images.first.image.url }}" 
                             alt="{{ variation.name }}" 
                             class="w-full h-full object-cover object-center">
                    </div>
                    <div class="ml-4 flex-1">
                        <div class="flex flex-col sm:flex-row sm:items-center gap-2">
                            <h4 class="font-medium text-gray-900">{{ variation.name|default:product.name }}</h4>
                            {% if variations_count > 1 %}
                            <span class="text-xs bg-blue-50 text-blue-700 px-2 py-0.5 rounded-full">
                                {{ variations_count }} variation{{ variations_count|pluralize }} available
                            </span>
                            {% endif %}
                        </div>
                        {% if variation.sku %}
                        <p class="text-sm text-gray-500">SKU: {{ variation.sku }}</p>
                        {% endif %}
                        <p class="mt-1 text-lg font-semibold text-blue-600">Ksh {{ variation.price|floatformat:2 }}</p>
                    </div>
                </div>

                
                
                <form id="variationsForm" method="post" action="{% url 'home:quick_checkout' %}" class="space-y-4">
                    {% csrf_token %}
                    <input type="hidden" name="next" value="{{ request.get_full_path }}">
                    
                    <div class="mt-4 border-t border-gray-200 pt-4">
                        <h4 class="text-sm font-medium text-gray-900 mb-3">Order Quantities</h4>
                        <div class="space-y-3 max-h-60 overflow-y-auto pr-2 -mr-2">
                            <!-- Current Variation -->
                            <div class="flex items-center p-2 rounded-md border border-blue-200 bg-blue-50">
                                <div class="flex-shrink-0 w-10 h-10 bg-gray-100 rounded overflow-hidden">
                                    <img src="{{ variation.image.url|default:product.images.first.image.url }}" 
                                         alt="{{ variation.name }}" 
                                         class="w-full h-full object-cover">
                                </div>
                                <div class="ml-3 min-w-0 flex-1">
                                    <p class="text-sm font-medium text-gray-900 truncate">{{ variation.name }}</p>
                                    <div class="flex justify-between items-center">
                                        <p class="text-sm text-gray-500">Ksh {{ variation.price|floatformat:2 }}</p>
                                        <span class="inline-flex items-center px-2 py-0.5 rounded text-xs font-medium bg-blue-100 text-blue-800">
                                            Selected
                                        </span>
                                    </div>
                                </div>
                                <div class="ml-4 flex items-center">
                                    <button type="button" onclick="decrementQuantity('{{ variation.id }}')" class="p-1 text-gray-500 hover:text-gray-700">
                                        <svg class="h-4 w-4" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M20 12H4" />
                                        </svg>
                                    </button>
                                    <input type="number" 
                                           name="quantity_{{ variation.id }}" 
                                           id="quantity_{{ variation.id }}" 
                                           min="{{ variation.moq|default:1 }}" 
                                           value="{{ variation.moq|default:1 }}" 
                                           step="{{ variation.moq|default:1 }}"
                                           class="w-12 mx-1 text-center border rounded-md py-1 text-sm"
                                           onchange="updateVariationTotal('{{ variation.id }}', {{ variation.price }})">
                                    <button type="button" onclick="incrementQuantity('{{ variation.id }}')" class="p-1 text-gray-500 hover:text-gray-700">
                                        <svg class="h-4 w-4" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 4v16m8-8H4" />
                                        </svg>
                                    </button>
                                </div>
                            </div>
                            
                            <!-- Other Variations -->
                            {% if variations_count > 1 %}
                                {% for var in variations %}
                                    {% if var.pk != variation.pk %}
                                    <div class="flex items-center p-2 rounded-md border border-gray-200 hover:border-gray-300">
                                        <div class="flex-shrink-0 w-10 h-10 bg-gray-100 rounded overflow-hidden">
                                            {% with var_images=var.images.all %}
                                            <img src="{% if var_images %}{{ var_images.0.image.url }}{% else %}{{ product.images.first.image.url }}{% endif %}" 
                                                 alt="{{ var.name }}" 
                                                 class="w-full h-full object-cover">
                                            {% endwith %}
                                        </div>
                                        <div class="ml-3 min-w-0 flex-1">
                                            <p class="text-sm font-medium text-gray-900 truncate">{{ var.name }}</p>
                                            <p class="text-sm text-gray-500">Ksh {{ var.price|floatformat:2 }}</p>
                                        </div>
                                        <div class="ml-4 flex items-center">
                                            <button type="button" onclick="decrementQuantity('{{ var.id }}')" class="p-1 text-gray-500 hover:text-gray-700">
                                                <svg class="h-4 w-4" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M20 12H4" />
                                                </svg>
                                            </button>
                                            <input type="number" 
                                                   name="quantity_{{ var.id }}" 
                                                   id="quantity_{{ var.id }}" 
                                                   min="0" 
                                                   value="0" 
                                                   class="w-12 mx-1 text-center border rounded-md py-1 text-sm"
                                                   onchange="updateVariationTotal('{{ var.id }}', {{ var.price }})">
                                            <button type="button" onclick="incrementQuantity('{{ var.id }}')" class="p-1 text-gray-500 hover:text-gray-700">
                                                <svg class="h-4 w-4" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 4v16m8-8H4" />
                                                </svg>
                                            </button>
                                        </div>
                                    </div>
                                    {% endif %}
                                {% endfor %}
                            {% endif %}
                        </div>
                    </div>
                    
                    <div class="mt-6 pt-4 border-t border-gray-200">
                        <div class="flex justify-between items-center mb-4">
                            <p class="text-sm font-medium text-gray-900">Order Total</p>
                            <p class="text-lg font-semibold text-blue-600">Ksh <span id="orderTotal">{{ variation.price|floatformat:2 }}</span></p>
                        </div>
                        <button type="submit" 
                                class="w-full flex justify-center py-2 px-4 border border-transparent rounded-md shadow-sm text-sm font-medium text-white bg-blue-600 hover:bg-blue-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-blue-500">
                            Proceed to Order
                        </button>
                    </div>
                </form>
            </div>
        </div>
    </div>
</div>

<script>
// Track all variation prices
const variationPrices = {
    {% for var in variations %}
    '{{ var.id }}': parseFloat('{{ var.price|floatformat:2 }}'){% if not forloop.last %},{% endif %}
    {% endfor %}
};

// Payment Plan Variables - Already defined at top of page

// Track quantities for each variation
let quantities = {
    '{{ variation.id }}': {{ variation.moq|default:1 }}  // Default to MOQ for current variation
    {% for var in variations %}
        {% if var.id != variation.id %}
        ,'{{ var.id }}': 0
        {% endif %}
    {% endfor %}
};

function openOrderModal() {
    document.getElementById('orderModal').style.display = 'flex';
    updateOrderTotal();
}

function closeOrderModal() {
    document.getElementById('orderModal').style.display = 'none';
}

function incrementQuantity(variationId) {
    const input = document.getElementById(`quantity_${variationId}`);
    input.stepUp();
    quantities[variationId] = parseInt(input.value);
    updateOrderTotal();
}

function decrementQuantity(variationId) {
    const input = document.getElementById(`quantity_${variationId}`);
    if (input.value > 0) {
        input.stepDown();
        quantities[variationId] = parseInt(input.value);
        updateOrderTotal();
    }
}

function updateVariationTotal(variationId, price) {
    const input = document.getElementById(`quantity_${variationId}`);
    quantities[variationId] = parseInt(input.value) || 0;
    updateOrderTotal();
}

function updateOrderTotal() {
    let total = 0;
    
    // Calculate total from all variations
    for (const [variationId, quantity] of Object.entries(quantities)) {
        if (variationPrices[variationId] && quantity > 0) {
            total += variationPrices[variationId] * quantity;
        }
    }
    
    // Update the display
    document.getElementById('orderTotal').textContent = total.toFixed(2);
    
    // Update the form action URL for quick checkout
    const form = document.getElementById('variationsForm');
    form.action = "{% url 'home:quick_checkout' %}";
}

// Close modal when clicking outside
window.addEventListener('click', function(event) {
    const modal = document.getElementById('orderModal');
    if (event.target === modal) {
        closeOrderModal();
    }
});

// Handle form submission to include all variations
const variationsForm = document.getElementById('variationsForm');
if (variationsForm) {
    variationsForm.addEventListener('submit', function(e) {
        // Ensure at least one item is selected
        let hasItems = false;
        
        // Add hidden inputs for each variation with quantity > 0
        for (const [variationId, quantity] of Object.entries(quantities)) {
            if (quantity > 0) {
                hasItems = true;
                // Create quantity input for each variation
                const input = document.createElement('input');
                input.type = 'hidden';
                input.name = `quantity_${variationId}`;
                input.value = quantity;
                variationsForm.appendChild(input);
            }
        }
        
        // Prevent form submission if no items are selected
        if (!hasItems) {
            e.preventDefault();
            alert('Please select at least one item to proceed.');
            return false;
        }
    });
}

// Payment Plan Functions - Already defined at top of page

// Payment plan initialization - Already handled at top of page
</script>

{% if has_promise_fee %}
<div id="promiseFeeModal" class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50 px-4 py-6" style="display: none;">
    <div class="bg-white rounded-lg shadow-xl max-w-md w-full max-h-[90vh] overflow-y-auto">
        <div class="p-6">
            <div class="flex justify-between items-center mb-4">
                <h3 class="text-xl font-semibold text-gray-900">✨ Promise Fee Available</h3>
                <button type="button" onclick="closePromiseFeeModal()" class="text-gray-400 hover:text-gray-500">
                    <span class="sr-only">Close</span>
                    <svg class="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12" />
                    </svg>
                </button>
            </div>
            <div class="space-y-4">
                <p class="text-gray-700">
                    This variation offers a <span class="font-semibold">Promise Fee</span> option, allowing you to:
                </p>
                <ul class="promise-fee-feature-list">
                    <li>Reserve this item with a small fee</li>
                    <li>Inspect the product in person at a local office</li>
                    <li>Complete the payment only if you're satisfied</li>
                    <li>No obligation to purchase if the product doesn't meet your expectations</li>
                </ul>
                <p class="text-gray-700">
                    Look for the "Pay Promise Fee" option in the order section.
                </p>
                <div class="mt-6">
                    <button type="button" onclick="closePromiseFeeModal()" class="w-full bg-indigo-600 text-white py-2 px-4 rounded-md hover:bg-indigo-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-indigo-500">
                        Got it, thanks!
                    </button>
                </div>
            </div>
        </div>
    </div>
</div>

<script>
// Show promise fee modal on page load if it exists
document.addEventListener('DOMContentLoaded', function() {
    const promiseFeeModal = document.getElementById('promiseFeeModal');
    if (promiseFeeModal) {
        // Only show if not already shown in this session
        if (!sessionStorage.getItem('promiseFeeModalShown_variation')) {
            promiseFeeModal.style.display = 'flex';
            sessionStorage.setItem('promiseFeeModalShown_variation', 'true');
        }
    }
});

// Close modal function
function closePromiseFeeModal() {
    const modal = document.getElementById('promiseFeeModal');
    if (modal) {
        modal.style.display = 'none';
    }
}

// Close modal when clicking outside the content
window.addEventListener('click', function(event) {
    const modal = document.getElementById('promiseFeeModal');
    if (event.target === modal) {
        closePromiseFeeModal();
    }
});
</script>
{% endif %}

<!-- Radial FAB -->
<div id="fabContainer" class="fixed bottom-6 right-6 z-50 fab-container">
  {% if product.business.phone %}
  <a href="https://wa.me/{{ product.business.phone|cut:' '|cut:'-'|cut:'('|cut:')' }}?text=Hi%20{{ product.business.name|urlencode }}%2C%20I'm%20interested%20in%20{{ product.name|urlencode }}%20(%20{{ variation.name|urlencode }}%20)"
     target="_blank" rel="noopener"
     class="fab-action fab-action--whatsapp bg-green-500 hover:bg-green-600 text-white w-12 h-12 rounded-full shadow-lg flex items-center justify-center focus:outline-none focus:ring-2 focus:ring-green-500 focus:ring-offset-2"
     aria-label="Chat on WhatsApp">
    <svg viewBox="0 0 32 32" width="24" height="24" fill="currentColor" aria-hidden="true">
      <path d="M19.11 17.24a5.51 5.51 0 0 1-2.44-2.44c-.22-.47-.11-.78.1-1l.24-.25c.19-.19.25-.5.14-.76l-.72-1.75c-.21-.5-.7-.82-1.24-.82a3.6 3.6 0 0 0-2.56 1.2 3.68 3.68 0 0 0-.93 2.59c0 2.5 2.27 5.39 5.2 6.56.62.25 1.18.41 1.68.52.26.06.53-.03.72-.22l1.02-1.03c.2-.2.3-.5.22-.78l-.45-1.62c-.07-.25-.3-.44-.58-.49l-.34-.06c-.2-.03-.41.03-.56.17l-.28.28c-.2.2-.52.31-.99.1Z"/>
      <path d="M16 3C9.375 3 4 8.375 4 15c0 2.15.567 4.167 1.558 5.917L4 29l8.292-1.525A11.88 11.88 0 0 0 16 27c6.625 0 12-5.375 12-12S22.625 3 16 3Zm0 22a9.93 9.93 0 0 1-5.08-1.392l-.364-.219-4.058 .747.747-4.058-.22-.364A9.93 9.93 0 0 1 6 15c0-5.523 4.477-10 10-10s10 4.477 10 10-4.477 10-10 10Z"/>
    </svg>
    <span class="fab-tooltip">WhatsApp</span>
  </a>
  {% endif %}

  <button type="button" id="aiChatButton"
          class="fab-action fab-action--ai bg-purple-600 hover:bg-purple-700 text-white w-12 h-12 rounded-full shadow-lg flex items-center justify-center focus:outline-none focus:ring-2 focus:ring-purple-500 focus:ring-offset-2" 
          aria-label="AI Chat">
    <svg viewBox="0 0 24 24" width="24" height="24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="w-6 h-6">
      <rect x="3" y="7" width="18" height="10" rx="2" ry="2"></rect>
      <path d="M8 7V5a4 4 0 0 1 8 0v2"></path>
      <circle cx="9" cy="12" r="1"></circle>
      <circle cx="15" cy="12" r="1"></circle>
      <path d="M8 17v1a4 4 0 0 0 8 0v-1"></path>
    </svg>
    <span class="fab-tooltip">AI Chat</span>
  </button>

  {% if request.user.is_authenticated %}
  {% if request.user != product.business.owner %}
  <a href="{% url 'home:start_chat_with_product' product.business.owner.id product.id %}"
     class="fab-action fab-action--seller bg-blue-600 hover:bg-blue-700 text-white w-12 h-12 rounded-full shadow-lg flex items-center justify-center focus:outline-none focus:ring-2 focus:ring-blue-500 focus:ring-offset-2"
     aria-label="Chat with Seller">
    <svg viewBox="0 0 24 24" width="24" height="24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" aria-hidden="true">
      <path d="M21 15a4 4 0 0 1-4 4H8l-4 4V7a4 4 0 0 1 4-4h9a4 4 0 0 1 4 4z"></path>
    </svg>
    <span class="fab-tooltip">Chat with Seller</span>
  </a>
  {% endif %}
  {% endif %}

  <button id="mainFab" 
          class="bg-indigo-600 hover:bg-indigo-700 text-white w-14 h-14 rounded-full shadow-lg flex items-center justify-center focus:outline-none focus:ring-2 focus:ring-indigo-500 focus:ring-offset-2"
          aria-label="Quick Actions" aria-expanded="false">
    <svg id="fabIcon" class="w-6 h-6 transform transition-transform duration-200" fill="none" stroke="currentColor" viewBox="0 0 24 24">
      <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 4v16m8-8H4"></path>
    </svg>
  </button>
</div>

<!-- Back to Top Button (offset) -->
<button id="backToTopRight" aria-label="Back to top" class="fixed bottom-6 right-24 w-14 h-14 bg-gray-700 hover:bg-gray-800 text-white rounded-full shadow-lg flex items-center justify-center transition-all duration-200 focus:outline-none focus:ring-2 focus:ring-gray-500 focus:ring-offset-2 z-40" title="Back to top">
  <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 15l7-7 7 7" />
  </svg>
</button>

<style>
.fab-container { position: fixed; bottom: 1.5rem; right: 1.5rem; width: 3.5rem; height: 3.5rem; }
.fab-container #mainFab { position: absolute; bottom: 0; right: 0; z-index: 40; }
.fab-action { position: absolute; bottom: 0.5rem; right: 0.5rem; opacity: 0; transform: translate(0,0) scale(0.9); transition: transform .25s ease, opacity .2s ease; z-index: 30; }
.fab-container.open .fab-action { opacity: 1; transform: scale(1); }
.fab-container.open .fab-action--whatsapp { transform: translate(-65px, -20px); }
.fab-container.open .fab-action--ai { transform: translate(-20px, -70px); }
.fab-container.open .fab-action--seller { transform: translate(-85px, -85px); }
.fab-tooltip { position: absolute; right: 3.25rem; top: 50%; transform: translateY(-50%); white-space: nowrap; background: rgba(17,24,39,.95); color:#fff; padding:.25rem .5rem; border-radius:.375rem; font-size:.75rem; box-shadow: 0 10px 15px -3px rgba(0,0,0,.1), 0 4px 6px -4px rgba(0,0,0,.1); opacity:0; pointer-events:none; transition: opacity .15s ease; }
.fab-container.open .fab-action .fab-tooltip { opacity: 1; }
/* Place AI tooltip to the right of its button */
.fab-action--ai .fab-tooltip { right: auto; left: 3.25rem; }
</style>

<script>
// Radial FAB behavior
document.addEventListener('DOMContentLoaded', function() {
  const fabContainer = document.getElementById('fabContainer');
  const mainFab = document.getElementById('mainFab');
  const fabIcon = document.getElementById('fabIcon');
  let isMenuOpen = false;

  function toggleFabMenu() {
    isMenuOpen = !isMenuOpen;
    fabContainer.classList.toggle('open', isMenuOpen);
    fabIcon.classList.toggle('rotate-45', isMenuOpen);
    mainFab.setAttribute('aria-expanded', isMenuOpen ? 'true' : 'false');
  }

  function closeFabMenu() {
    if (isMenuOpen) toggleFabMenu();
  }

  mainFab.addEventListener('click', toggleFabMenu);
  document.addEventListener('click', (e) => {
    if (isMenuOpen && !fabContainer.contains(e.target)) {
      closeFabMenu();
    }
  });
  // Close when clicking any action
  document.querySelectorAll('#fabContainer .fab-action').forEach(el => {
    el.addEventListener('click', closeFabMenu);
  });

  // Back to top behavior
  const btn = document.getElementById('backToTopRight');
  if (btn) {
    let rafId;
    function toggleBtn() {
      if (rafId) cancelAnimationFrame(rafId);
      rafId = requestAnimationFrame(function() {
        if (window.scrollY > 200) {
          btn.classList.add('show');
        } else {
          btn.classList.remove('show');
        }
      });
    }
    window.addEventListener('scroll', toggleBtn, { passive: true });
    toggleBtn();
    btn.addEventListener('click', function () {
      window.scrollTo({ top: 0, behavior: 'smooth' });
    });
  }
});
</script>
{% endblock %}