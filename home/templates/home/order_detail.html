{% extends 'users/base.html' %}
{% load static humanize order_filters %}

{% block title %}Order #{{ order.id }} - {{ block.super }}{% endblock %}

{% block content %}
{% csrf_token %}
<div class="min-h-screen bg-gray-50 py-8 px-4 sm:px-6 lg:px-8">
    <div class="max-w-5xl mx-auto">
        <!-- Order Header -->
        <div class="bg-white shadow overflow-hidden sm:rounded-lg mb-8">
            <div class="px-4 py-5 sm:px-6 flex flex-col sm:flex-row sm:items-center sm:justify-between">
                <div>
                    <h1 class="text-2xl font-bold text-gray-900">Order #{{ order.id }}</h1>
                    <div class="mt-1 flex flex-col sm:flex-row sm:flex-wrap sm:mt-0 sm:space-x-6">
                        <div class="mt-2 flex items-center text-sm text-gray-500">
                            <svg class="flex-shrink-0 mr-1.5 h-5 w-5 text-gray-400" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 20 20" fill="currentColor">
                                <path fill-rule="evenodd" d="M6 2a1 1 0 00-1 1v1H4a2 2 0 00-2 2v10a2 2 0 002 2h12a2 2 0 002-2V6a2 2 0 00-2-2h-1V3a1 1 0 10-2 0v1H7V3a1 1 0 00-1-1zm0 5a1 1 0 000 2h8a1 1 0 100-2H6z" clip-rule="evenodd" />
                            </svg>
                            {{ order.created_at|date:"F j, Y" }}
                        </div>
                        <div class="mt-2 flex items-center text-sm text-gray-500">
                            <span class="px-2.5 py-0.5 rounded-full text-xs font-medium 
                                {% if order.status == 'completed' %}bg-green-100 text-green-800
                                {% elif order.status == 'cancelled' %}bg-red-100 text-red-800
                                {% elif order.status == 'processing' %}bg-blue-100 text-blue-800
                                {% else %}bg-yellow-100 text-yellow-800{% endif %}">
                                {{ order.get_status_display }}
                            </span>
                        </div>
                    </div>
                </div>
                <div class="mt-4 sm:mt-0">
                    <a href="{% url 'home:order_history' %}" class="inline-flex items-center px-4 py-2 border border-gray-300 shadow-sm text-sm font-medium rounded-md text-gray-700 bg-white hover:bg-gray-50 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-indigo-500">
                        <svg class="-ml-1 mr-2 h-5 w-5 text-gray-500" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 20 20" fill="currentColor">
                            <path fill-rule="evenodd" d="M12.707 5.293a1 1 0 010 1.414L9.414 10l3.293 3.293a1 1 0 01-1.414 1.414l-4-4a1 1 0 010-1.414l4-4a1 1 0 011.414 0z" clip-rule="evenodd" />
                        </svg>
                        Back to Orders
                    </a>
                </div>
            </div>
        </div>

        <div class="grid grid-cols-1 lg:grid-cols-3 gap-6">
            <!-- Order Items -->
            <div class="lg:col-span-2 space-y-6">
                <div class="bg-white shadow overflow-hidden sm:rounded-lg">
                    <div class="px-4 py-5 sm:px-6 border-b border-gray-200">
                        <h3 class="text-lg leading-6 font-medium text-gray-900">Order Items</h3>
                    </div>
                    <div class="divide-y divide-gray-200">
                        {% for item in items %}
                        <div class="p-4 sm:px-6 hover:bg-gray-50 transition-colors duration-150">
                            <div class="flex items-start">
                                <div class="flex-shrink-0 w-20 h-20 rounded-md overflow-hidden border border-gray-200">
                                    {% with item.variation.images.all|first as image %}
                                    <img src="{% if image %}{{ image.image.url }}{% else %}{% static 'images/placeholder-product.png' %}{% endif %}" 
                                         alt="{{ item.variation.name }}" 
                                         class="w-full h-full object-cover object-center">
                                    {% endwith %}
                                </div>
                                <div class="ml-4 flex-1">
                                    <div class="flex justify-between">
                                        <div>
                                            <h4 class="text-sm font-medium text-gray-900">{{ item.variation.product.name }}</h4>
                                            <p class="mt-1 text-sm text-gray-500">{{ item.variation.name }}</p>
                                            <p class="mt-1 text-sm text-gray-500">Qty: {{ item.quantity }}</p>
                                        </div>
                                        <p class="text-sm font-medium text-gray-900">KSh {{ item.price|intcomma }}</p>
                                    </div>
                                    <div class="mt-2 flex justify-between items-center">
                                        <p class="text-sm text-gray-500">Subtotal</p>
                                        <p class="text-sm font-medium text-gray-900">KSh {{ item.subtotal|intcomma }}</p>
                                    </div>
                                </div>
                            </div>
                        </div>
                        {% endfor %}
                        
                        <!-- Additional Fees Section -->
                        {% if additional_fees %}
                        <div class="border-t border-gray-200">
                            <div class="px-4 py-3 bg-gray-50">
                                <h4 class="text-sm font-medium text-gray-900">Additional Fees</h4>
                            </div>
                            {% for fee in additional_fees %}
                            <div class="p-4 sm:px-6 hover:bg-gray-50 transition-colors duration-150 border-b border-gray-100">
                                <div class="flex justify-between items-center">
                                    <div>
                                        <span class="text-sm font-medium text-gray-900">{{ fee.fee_type }}</span>
                                        {% if fee.description %}
                                        <p class="text-xs text-gray-500 mt-1">{{ fee.description }}</p>
                                        {% endif %}
                                        <span class="inline-flex items-center px-2 py-0.5 rounded text-xs font-medium mt-1 fee-pay-now {% if fee.pay_now %}bg-green-100 text-green-800{% else %}bg-yellow-100 text-yellow-800{% endif %}">
                                            {% if fee.pay_now %}Paid Now{% else %}Pay Later{% endif %}
                                        </span>
                                    </div>
                                    <span class="text-sm font-medium text-gray-900 fee-amount">KSh {{ fee.amount|intcomma }}</span>
                                </div>
                            </div>
                            {% endfor %}
                        </div>
                        {% endif %}
                    </div>
                </div>

                <!-- Order Summary -->
                <div class="bg-white shadow overflow-hidden sm:rounded-lg">
                    <div class="px-4 py-5 sm:px-6 border-b border-gray-200">
                        <h3 class="text-lg leading-6 font-medium text-gray-900">Order Summary</h3>
                    </div>
                    <div class="px-4 py-5 sm:p-6">
                        <dl class="space-y-4">
                            <div class="flex items-center justify-between">
                                <dt class="text-sm text-gray-600">Subtotal</dt>
                                <dd class="text-sm font-medium text-gray-900">KSh {{ order.subtotal|default:order.total|intcomma }}</dd>
                            </div>
                            {% if order.pay_now is not None %}
                            <div class="flex items-center justify-between">
                                <dt class="text-sm text-gray-600">Pay Now</dt>
                                <dd class="text-sm font-medium text-green-600">KSh {{ order.pay_now|default:0|floatformat:2|intcomma }}</dd>
                            </div>
                            {% if order.pay_later > 0 %}
                            <div class="flex items-center justify-between">
                                <dt class="text-sm text-gray-600">Pay Later</dt>
                                <dd class="text-sm font-medium text-yellow-600">KSh {{ order.pay_later|default:0|floatformat:2|intcomma }}</dd>
                            </div>
                            {% endif %}
                            {% endif %}
                            {% if order.shipping_cost %}
                            <div class="flex items-center justify-between">
                                <dt class="text-sm text-gray-600">Shipping</dt>
                                <dd class="text-sm font-medium text-gray-900">KSh {{ order.shipping_cost|intcomma }}</dd>
                            </div>
                            {% endif %}
                            {% if order.discount_amount %}
                            <div class="flex items-center justify-between">
                                <dt class="text-sm text-gray-600">Discount</dt>
                                <dd class="text-sm font-medium text-red-600">- KSh {{ order.discount_amount|intcomma }}</dd>
                            </div>
                            {% endif %}
                            
                            <!-- Total Additional Fees (hidden but still used in total calculation) -->
                            {% if additional_fees %}
                            <div class="hidden">
                                {{ additional_fees|sum_fees }}
                            </div>
                            {% endif %}
                            
                            <div class="border-t border-gray-200 pt-4 flex items-center justify-between">
                                <dt class="text-base font-medium text-gray-900">Total</dt>
                                <dd class="text-base font-medium text-gray-900">
                                    KSh {{ order|calculate_order_total:additional_fees|intcomma }}
                                </dd>
                            </div>
                        </dl>
                    </div>
                </div>
            </div>

            <!-- Order Details -->
            <div class="space-y-6">
                <!-- M-Pesa Payment Section -->
                <div class="bg-white shadow overflow-hidden sm:rounded-lg">
                    <div class="px-4 py-5 sm:px-6 border-b border-gray-200">
                        <h3 class="text-lg leading-6 font-medium text-gray-900 flex items-center">
                            <svg class="w-6 h-6 mr-2 text-green-600" fill="currentColor" viewBox="0 0 24 24">
                                <path d="M12 2C6.48 2 2 6.48 2 12s4.48 10 10 10 10-4.48 10-10S17.52 2 12 2zm-2 15l-5-5 1.41-1.41L10 14.17l7.59-7.59L19 8l-9 9z"/>
                            </svg>
                            M-Pesa Payment
                        </h3>
                    </div>
                    <div class="px-4 py-5 sm:p-6">
                        <div class="space-y-4">
                            <div>
                                <label for="mpesa-phone" class="block text-sm font-medium text-gray-700">Phone Number</label>
                                <div class="mt-1">
                                    <input type="tel" 
                                           id="mpesa-phone" 
                                           name="mpesa-phone"
                                           placeholder="07XXXXXXXX or 254XXXXXXXXX"
                                           class="block w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-2 focus:ring-green-500 focus:border-green-500 sm:text-sm">
                                </div>
                                <p class="mt-1 text-xs text-gray-500">Enter your M-Pesa registered phone number</p>
                            </div>
                            <div class="bg-green-50 border border-green-200 rounded-md p-3">
                                <div class="flex">
                                    <div class="flex-shrink-0">
                                        <svg class="h-5 w-5 text-green-400" viewBox="0 0 20 20" fill="currentColor">
                                            <path fill-rule="evenodd" d="M18 10a8 8 0 11-16 0 8 8 0 0116 0zm-7-4a1 1 0 11-2 0 1 1 0 012 0zM9 9a1 1 0 000 2v3a1 1 0 001 1h1a1 1 0 100-2v-3a1 1 0 00-1-1H9z" clip-rule="evenodd" />
                                        </svg>
                                    </div>
                                    <div class="ml-3">
                                        <p class="text-sm text-green-700">
                                            You will receive an M-Pesa STK push notification to complete the payment.
                                        </p>
                                    </div>
                                </div>
                            </div>
                            <button type="button" 
                                    id="mpesa-pay-btn"
                                    class="w-full flex justify-center items-center px-4 py-2 border border-transparent rounded-md shadow-sm text-sm font-medium text-white bg-green-600 hover:bg-green-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-green-500 disabled:opacity-50 disabled:cursor-not-allowed">
                                <svg class="w-5 h-5 mr-2" fill="currentColor" viewBox="0 0 24 24">
                                    <path d="M12 2C6.48 2 2 6.48 2 12s4.48 10 10 10 10-4.48 10-10S17.52 2 12 2zm-2 15l-5-5 1.41-1.41L10 14.17l7.59-7.59L19 8l-9 9z"/>
                                </svg>
                                {% if order.pay_now and order.pay_now > 0 %}
                                    Pay with M-Pesa - KSh {{ order.pay_now|floatformat:2|intcomma }} (Pay Now)
                                {% else %}
                                    Pay with M-Pesa - KSh {{ order.total|floatformat:2|intcomma }}
                                {% endif %}
                            </button>
                        </div>
                    </div>
                </div>

                <!-- Payment Information -->
                <div class="bg-white shadow overflow-hidden sm:rounded-lg">
                    <div class="px-4 py-5 sm:px-6 border-b border-gray-200">
                        <h3 class="text-lg leading-6 font-medium text-gray-900 flex items-center">
                            <svg class="w-6 h-6 mr-2 text-gray-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12l2 2 4-4m6 2a9 9 0 11-18 0 9 9 0 0118 0z"/>
                            </svg>
                            Payment Information
                        </h3>
                    </div>
                    <div class="px-4 py-5 sm:p-6">
                        <div class="space-y-6">
                            <!-- Current Payment Status -->
                            <div class="space-y-4">
                                <div class="flex items-center justify-between">
                                    <span class="text-sm font-medium text-gray-700">Payment Method</span>
                                    <span class="text-sm text-gray-900">
                                        {% if payment_info.payment_method == 'mpesa' %}
                                            <span class="flex items-center">
                                                <svg class="w-4 h-4 mr-1 text-green-600" fill="currentColor" viewBox="0 0 24 24">
                                                    <path d="M12 2C6.48 2 2 6.48 2 12s4.48 10 10 10 10-4.48 10-10S17.52 2 12 2zm-2 15l-5-5 1.41-1.41L10 14.17l7.59-7.59L19 8l-9 9z"/>
                                                </svg>
                                                M-Pesa
                                            </span>
                                        {% elif payment_info.payment_method == 'card' %}
                                            <span class="flex items-center">
                                                <svg class="w-4 h-4 mr-1 text-blue-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M3 10h18M7 15h1m4 0h1m-7 4h12a3 3 0 003-3V8a3 3 0 00-3-3H6a3 3 0 00-3 3v8a3 3 0 003 3z"/>
                                                </svg>
                                                Card Payment
                                            </span>
                                        {% else %}
                                            {{ payment_info.payment_method|default:"Not specified" }}
                                        {% endif %}
                                    </span>
                                </div>
                          
                            </div>

                            <!-- Completed Payments -->
                            {% if completed_payments %}
                                <div class="border-t border-gray-200 pt-4 mt-4">
                                    <h4 class="text-sm font-medium text-gray-700 mb-3">Payment History</h4>
                                    <div class="space-y-3">
                                        {% for payment in completed_payments %}
                                            <div class="bg-gray-50 p-3 rounded-md">
                                                <div class="flex justify-between items-start">
                                                    <div>
                                                        <p class="text-sm font-medium text-gray-900">
                                                            {% if payment.payment_method == 'mpesa' %}
                                                                <span class="flex items-center">
                                                                    <svg class="w-4 h-4 mr-1 text-green-600" fill="currentColor" viewBox="0 0 24 24">
                                                                        <path d="M12 2C6.48 2 2 6.48 2 12s4.48 10 10 10 10-4.48 10-10S17.52 2 12 2zm-2 15l-5-5 1.41-1.41L10 14.17l7.59-7.59L19 8l-9 9z"/>
                                                                    </svg>
                                                                    M-Pesa Payment
                                                                </span>
                                                            {% else %}
                                                                {{ payment.payment_method|title }} Payment
                                                            {% endif %}
                                                        </p>
                                                        {% if payment.transaction_id %}
                                                            <p class="text-xs text-gray-500 mt-1">
                                                                Txn: <span class="font-mono">{{ payment.transaction_id|truncatechars:16 }}</span>
                                                            </p>
                                                        {% endif %}
                                                        {% if payment.mpesa_receipt %}
                                                            <p class="text-xs text-gray-500">
                                                                Receipt: <span class="font-mono">{{ payment.mpesa_receipt }}</span>
                                                            </p>
                                                        {% endif %}
                                                    </div>
                                                    <div class="text-right">
                                                        <p class="text-sm font-medium text-gray-900">KSh {{ payment.amount|floatformat:2|intcomma }}</p>
                                                        <p class="text-xs text-gray-500">{{ payment.created_at|date:"M j, Y g:i A" }}</p>
                                                    </div>
                                                </div>
                                                {% if payment.phone_number %}
                                                    <p class="text-xs text-gray-500 mt-2">
                                                        <span class="font-medium">Phone:</span> {{ payment.phone_number }}
                                                    </p>
                                                {% endif %}
                                            </div>
                                        {% endfor %}
                                    </div>
                                </div>
                            {% endif %}
                            
                            <!-- Completed Payment Requests -->
                            {% if completed_payment_requests %}
                                <div class="border-t border-gray-200 pt-6 mt-6">
                                    <h4 class="text-sm font-semibold text-gray-800 mb-4 flex items-center">
                                        <svg class="w-4 h-4 mr-2 text-gray-600" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg">
                                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 5H7a2 2 0 00-2 2v12a2 2 0 002 2h10a2 2 0 002-2V7a2 2 0 00-2-2h-2M9 5a2 2 0 002 2h2a2 2 0 002-2M9 5a2 2 0 012-2h2a2 2 0 012 2"></path>
                                        </svg>
                                        Payment Requests
                                    </h4>
                                    <div class="overflow-hidden border border-gray-200 rounded-lg shadow-sm">
                                        <table class="min-w-full divide-y divide-gray-200">
                                            <thead class="bg-gray-50">
                                                <tr>
                                                    <th scope="col" class="px-4 py-3 text-left text-xs font-medium text-gray-600 uppercase tracking-wider">Date</th>
                                                    <th scope="col" class="px-4 py-3 text-left text-xs font-medium text-gray-600 uppercase tracking-wider">Receipt Number</th>
                                                    <th scope="col" class="px-4 py-3 text-right text-xs font-medium text-gray-600 uppercase tracking-wider">Amount</th>
                                                </tr>
                                            </thead>
                                            <tbody class="bg-white divide-y divide-gray-100">
                                                {% for payment_request in completed_payment_requests %}
                                                <tr class="transition-colors hover:bg-blue-50">
                                                    <td class="px-4 py-3 whitespace-nowrap text-sm font-medium text-gray-600">
                                                        {{ payment_request.updated_at|date:"d/m" }}
                                                    </td>
                                                    <td class="px-4 py-3 whitespace-nowrap text-sm font-mono text-blue-600">
                                                        {{ payment_request.mpesa_receipt_number|default:payment_request.transaction_id|default:"N/A" }}
                                                    </td>
                                                    <td class="px-4 py-3 whitespace-nowrap text-sm font-semibold text-gray-900 text-right">
                                                        KSh {{ payment_request.amount|floatformat:2|intcomma }}
                                                    </td>
                                                </tr>
                                                {% endfor %}
                                            </tbody>
                                        </table>
                                    </div>
                                </div>
                            {% endif %}
                        </div>
                    </div>
                </div>

                <!-- Order Actions -->
                <div class="bg-white shadow overflow-hidden sm:rounded-lg">
                    <div class="px-4 py-5 sm:px-6">
                        <h3 class="text-lg leading-6 font-medium text-gray-900">Need Help?</h3>
                    </div>
                    <div class="px-4 py-5 sm:p-6">
                        <p class="text-sm text-gray-500 mb-4">If you have any questions about your order, please contact our customer service.</p>
                        <a href="" class="w-full flex items-center justify-center px-4 py-2 border border-transparent rounded-md shadow-sm text-sm font-medium text-white bg-indigo-600 hover:bg-indigo-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-indigo-500">
                            Contact Support
                        </a>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>



<script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
<script>
// Function to get cookie value by name
function getCookie(name) {
    let cookieValue = null;
    if (document.cookie && document.cookie !== '') {
        const cookies = document.cookie.split(';');
        for (let i = 0; i < cookies.length; i++) {
            const cookie = cookies[i].trim();
            if (cookie.substring(0, name.length + 1) === (name + '=')) {
                cookieValue = decodeURIComponent(cookie.substring(name.length + 1));
                break;
            }
        }
    }
    return cookieValue;
}

document.addEventListener('DOMContentLoaded', function() {
    // M-Pesa Payment Handler
    const mpesaPayBtn = document.getElementById('mpesa-pay-btn');
    const mpesaPhoneInput = document.getElementById('mpesa-phone');
    
    mpesaPayBtn.addEventListener('click', async function() {
        const phoneNumber = mpesaPhoneInput.value.trim();
        
        if (!phoneNumber) {
            Swal.fire({
                icon: 'error',
                title: 'Error',
                text: 'Please enter your phone number',
                confirmButtonText: 'OK'
            });
            return;
        }
        
        // Validate phone number format
        const phoneRegex = /^(07|254)[0-9]{8,9}$/;
        if (!phoneRegex.test(phoneNumber)) {
            Swal.fire({
                icon: 'error',
                title: 'Error',
                text: 'Please enter a valid phone number (07XXXXXXXX or 254XXXXXXXXX)',
                confirmButtonText: 'OK'
            });
            return;
        }
        
        // Get CSRF token
        const csrfToken = getCookie('csrftoken');
        if (!csrfToken) {
            console.error('CSRF token not found');
            Swal.fire({
                icon: 'error',
                title: 'Security Error',
                text: 'Security error. Please refresh the page and try again.',
                confirmButtonText: 'OK'
            });
            return;
        }
        
        // Disable button and show loading
        mpesaPayBtn.disabled = true;
        mpesaPayBtn.innerHTML = `
            <svg class="animate-spin -ml-1 mr-3 h-5 w-5 text-white" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24">
                <circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle>
                <path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path>
            </svg>
            Processing...
        `;
        
        try {
            console.log('Sending M-Pesa payment request...');
            
            // Calculate payment amount
            let paymentAmount = 0;
            const payNowAmount = parseFloat('{{ order.pay_now|default:0 }}');
            
            if (payNowAmount > 0) {
                // Use pay_now amount if available and greater than 0
                paymentAmount = payNowAmount;
                console.log(`Using pay_now amount: ${paymentAmount}`);
            } else {
                // Otherwise calculate total from order items and pay_now fees
                const orderTotal = parseFloat('{{ order.total|default:0 }}');
                
                // Get all pay_now fees
                const payNowFees = Array.from(document.querySelectorAll('.fee-item')).reduce((sum, feeItem) => {
                    const isPayNow = feeItem.querySelector('.fee-pay-now')?.textContent?.trim() === 'Paid Now';
                    if (isPayNow) {
                        const amountText = feeItem.querySelector('.fee-amount')?.textContent || '';
                        const amount = parseFloat(amountText.replace(/[^0-9.]/g, '')) || 0;
                        return sum + amount;
                    }
                    return sum;
                }, 0);
                
                paymentAmount = orderTotal + payNowFees;
                console.log(`Calculated payment amount: ${paymentAmount} (order total: ${orderTotal}, pay_now fees: ${payNowFees})`);
            }
            
            if (paymentAmount <= 0) {
                throw new Error('Invalid payment amount. Please contact support.');
            }
            
            // Make M-Pesa payment request
            const response = await fetch('/api/process-mpesa-payment/', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                    'X-CSRFToken': csrfToken,
                    'X-Requested-With': 'XMLHttpRequest'
                },
                body: JSON.stringify({
                    phone_number: phoneNumber,
                    order_id: '{{ order.id }}',
                    amount: paymentAmount,
                    callback_url: window.location.origin + '/api/mpesa-callback/'
                }),
                credentials: 'same-origin'
            });
            
            console.log('Response status:', response.status);
            
            if (!response.ok) {
                const errorData = await response.json().catch(() => ({}));
                console.error('Payment error response:', errorData);
                throw new Error(errorData.error || `Server responded with status ${response.status}`);
            }
            
            const data = await response.json();
            console.log('Payment response data:', data);
            
            if (data.success) {
                console.log('Payment request started successfully');
                
                // Show success message and start polling
                // Handle successful STK push response
                handleStkPushResponse(data);
            } else {
                throw new Error(data.error || data.message || 'Payment initiation failed');
            }
        } catch (error) {
            console.error('Payment error:', error);
            Swal.fire({
                icon: 'error',
                title: 'Error',
                text: error.message || 'An error occurred. Please try again.',
                confirmButtonText: 'OK'
            });
            resetMpesaButton();
        }
    });
    
    // Helper function to reset the M-Pesa button state
    function resetMpesaButton() {
        const mpesaPayBtn = document.getElementById('mpesa-pay-btn');
        if (mpesaPayBtn) {
            mpesaPayBtn.disabled = false;
            mpesaPayBtn.innerHTML = `
                <svg class="w-5 h-5 mr-2" fill="currentColor" viewBox="0 0 24 24">
                    <path d="M12 2C6.48 2 2 6.48 2 12s4.48 10 10 10 10-4.48 10-10S17.52 2 12 2zm-2 15l-5-5 1.41-1.41L10 14.17l7.59-7.59L19 8l-9 9z"/>
                </svg>
                Pay with M-Pesa - KSh {{ order.total|intcomma }}
            `;
        }
    }
    
    // Function to verify payment status
    async function verifyPayment(checkoutRequestId) {
        try {
            const response = await fetch(`/api/check-payment-status/${checkoutRequestId}/`);
            const data = await response.json();
            
            if (data.is_successful) {
                // If payment is successful, reload the page to show updated status
                window.location.reload();
            } else if (data.status === 'pending') {
                // If still pending, show appropriate message
                Swal.fire({
                    icon: 'info',
                    title: 'Payment Pending',
                    text: data.message || 'Your payment is still being processed. Please try again in a moment.',
                    confirmButtonText: 'OK'
                });
            } else {
                // If failed or other status
                Swal.fire({
                    icon: 'warning',
                    title: 'Payment Not Complete',
                    text: data.message || 'The payment has not been completed yet. Please try again after completing the payment on your phone.',
                    confirmButtonText: 'OK'
                });
            }
        } catch (error) {
            console.error('Error verifying payment:', error);
            Swal.fire({
                icon: 'error',
                title: 'Error',
                text: 'Failed to verify payment status. Please try again.',
                confirmButtonText: 'OK'
            });
        }
    }

    // Function to handle STK push response
    function handleStkPushResponse(response) {
        if (response.success) {
            // Save checkout request ID to session storage
            if (response.checkout_request_id) {
                sessionStorage.setItem('lastCheckoutRequestId', response.checkout_request_id);
            }
            
            // Show success message with only the 'I've Completed Payment' button
            Swal.fire({
                icon: 'info',
                title: 'Payment Request Sent',
                html: `
                    <div class="text-left">
                        <p class="mb-4">âœ… M-PESA payment request sent to your phone.</p>
                        <p class="mb-4">ðŸ“± <strong>Please check your phone and enter your M-PESA PIN</strong> to complete the transaction.</p>
                        <p class="text-sm text-gray-600 mb-4">If you don't see the prompt, check your phone's notifications or dial *234# to complete the payment.</p>
                        <p class="text-sm font-medium text-blue-600 mt-4">Click the button below after completing the payment on your phone.</p>
                    </div>
                `,
                showConfirmButton: true,
                confirmButtonText: 'I\'ve Completed Payment',
                showCancelButton: false,
                showDenyButton: false,
                focusConfirm: true,
                allowOutsideClick: false
            }).then(() => {
                // Reload the page immediately when the button is clicked
                window.location.reload();
            });
        } else {
            // Show error message
            Swal.fire({
                icon: 'error',
                title: 'Payment Failed',
                text: response.message || 'Failed to initiate payment. Please try again.',
                showConfirmButton: true
            });
        }
    }
});
</script>

{% endblock %}