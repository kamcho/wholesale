{% extends 'users/base.html' %}
{% load static %}
{% load humanize %}

{% block extra_css %}
{{ block.super }}
<link rel="stylesheet" href="{% static 'css/chat.css' %}">
<link href="https://fonts.googleapis.com/css2?family=Poppins:wght@400;500;600;700&display=swap" rel="stylesheet">
<style>
    .product-title {
        font-family: 'Poppins', sans-serif;
        font-weight: 700;
        letter-spacing: -0.5px;
        line-height: 1.2;
    }
    .variation-title {
        font-family: 'Poppins', sans-serif;
        font-weight: 600;
        letter-spacing: -0.3px;
    }
</style>
{% endblock %}

{% block title %}{{ product.name }} - WholeSaleHub{% endblock %}

{% block content %}
<!-- Add data attributes for chat initialization -->
<div data-product-id="{{ product.id }}" data-variation-id="{{ variation.id|default:'' }}" id="chat-data"></div>
<!-- Breadcrumb -->
<div class="bg-gray-50 py-4">
    <div class="max-w-7xl mx-auto px-4">
        <nav class="flex" aria-label="Breadcrumb">
            <ol class="flex items-center space-x-2">
                <li><a href="{% url 'home:home' %}" class="text-blue-600 hover:text-blue-800">Home</a></li>
                <li><span class="text-gray-400">/</span></li>
                <li><a href="{% url 'home:product_list' %}" class="text-blue-600 hover:text-blue-800">Products</a></li>
                <li><span class="text-gray-400">/</span></li>
                <li><span class="text-gray-900">{{ product.name }}</span></li>
            </ol>
        </nav>
        {% if product.business.phone %}
        {% with msg="Hi "|add:product.business.name|add:", I'm interested in "|add:product.name|add:"." %}
        <!-- Removed standalone floating WhatsApp button -->
        {% endwith %}
        {% endif %}

        <!-- Main Floating Action Button -->
        <div id="fabContainer" class="fixed bottom-6 right-6 z-50 fab-container">
             <!-- WhatsApp Button -->
            <a href="https://wa.me/{{ product.business.phone|cut:' '|cut:'-'|cut:'('|cut:')' }}?text=Hi%20{{ product.business.name|urlencode }}%2C%20I'm%20interested%20in%20{{ product.name|urlencode }}"
               target="_blank" 
               rel="noopener" 
               class="fab-action fab-action--whatsapp bg-green-500 hover:bg-green-600 text-white w-12 h-12 rounded-full shadow-lg flex items-center justify-center focus:outline-none focus:ring-2 focus:ring-green-500 focus:ring-offset-2"
               aria-label="Chat on WhatsApp">
                <svg viewBox="0 0 32 32" width="24" height="24" fill="currentColor" aria-hidden="true">
                    <path d="M19.11 17.24a5.51 5.51 0 0 1-2.44-2.44c-.22-.47-.11-.78.1-1l.24-.25c.19-.19.25-.5.14-.76l-.72-1.75c-.21-.5-.7-.82-1.24-.82a3.6 3.6 0 0 0-2.56 1.2 3.68 3.68 0 0 0-.93 2.59c0 2.5 2.27 5.39 5.2 6.56.62.25 1.18.41 1.68.52.26.06.53-.03.72-.22l1.02-1.03c.2-.2.3-.5.22-.78l-.45-1.62c-.07-.25-.3-.44-.58-.49l-.34-.06c-.2-.03-.41.03-.56.17l-.28.28c-.2.2-.52.31-.99.1Z"/>
                    <path d="M16 3C9.375 3 4 8.375 4 15c0 2.15.567 4.167 1.558 5.917L4 29l8.292-1.525A11.88 11.88 0 0 0 16 27c6.625 0 12-5.375 12-12S22.625 3 16 3Zm0 22a9.93 9.93 0 0 1-5.08-1.392l-.364-.219-4.058 .747.747-4.058-.22-.364A9.93 9.93 0 0 1 6 15c0-5.523 4.477-10 10-10s10 4.477 10 10-4.477 10-10 10Z"/>
                </svg>
                <span class="fab-tooltip">WhatsApp</span>
            </a>

            <!-- AI Chat Button -->
            <button type="button" 
                    id="aiChatButton" 
                    class="fab-action fab-action--ai bg-purple-600 hover:bg-purple-700 text-white w-12 h-12 rounded-full shadow-lg flex items-center justify-center focus:outline-none focus:ring-2 focus:ring-purple-500 focus:ring-offset-2" 
                    aria-label="AI Chat">
                <svg viewBox="0 0 24 24" width="24" height="24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="w-6 h-6">
                    <rect x="3" y="7" width="18" height="10" rx="2" ry="2"></rect>
                    <path d="M8 7V5a4 4 0 0 1 8 0v2"></path>
                    <circle cx="9" cy="12" r="1"></circle>
                    <circle cx="15" cy="12" r="1"></circle>
                    <path d="M8 17v1a4 4 0 0 0 8 0v-1"></path>
                </svg>
                <span id="aiUnreadBadge" class="absolute -top-1 -right-1 bg-red-500 text-white text-xs font-bold rounded-full h-5 w-5 flex items-center justify-center hidden">!</span>
                <span class="fab-tooltip">AI Chat</span>
            </button>

            <!-- Contact Seller Button -->
            {% if request.user.is_authenticated and request.user != product.user %}
            <a href="{% url 'home:start_chat' product.user.id %}?product_id={{ product.id }}" 
               class="fab-action fab-action--seller bg-blue-600 hover:bg-blue-700 text-white w-12 h-12 rounded-full shadow-lg flex items-center justify-center focus:outline-none focus:ring-2 focus:ring-blue-500 focus:ring-offset-2" 
               aria-label="Contact Seller">
                <svg viewBox="0 0 24 24" width="24" height="24" fill="currentColor" aria-hidden="true">
                    <path d="M21 21l-6-6m2-5a7 7 0 11-14 0 7 7 0 0114 0z"/>
                </svg>
                <span class="fab-tooltip">Chat with Seller</span>
            </a>
            {% endif %}

            <!-- Main FAB -->
            <button id="mainFab" 
                    class="bg-indigo-600 hover:bg-indigo-700 text-white w-14 h-14 rounded-full shadow-lg flex items-center justify-center focus:outline-none focus:ring-2 focus:ring-indigo-500 focus:ring-offset-2"
                    aria-label="Quick Actions"
                    aria-expanded="false">
                <svg id="fabIcon" class="w-6 h-6 transform transition-transform duration-200" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 4v16m8-8H4"></path>
                </svg>
            </button>
        </div>

        <!-- AI Chat Container -->
        <div id="aiChatContainer" class="fixed bottom-24 right-6 w-80 h-[500px] bg-white rounded-lg shadow-xl border border-gray-200 z-40 hidden flex-col overflow-hidden">
            <div class="bg-purple-600 text-white p-4 flex justify-between items-center">
                <h3 class="font-semibold">AI Assistant</h3>
                <div class="flex items-center space-x-2">
                    <button id="aiExpandButton" class="text-white hover:text-gray-200 focus:outline-none" title="Expand">
                        <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" viewBox="0 0 20 20" fill="currentColor">
                            <path fill-rule="evenodd" d="M3 3a1 1 0 011-1h4a1 1 0 110 2H6.414l3.293 3.293a1 1 0 11-1.414 1.414L5 5.414V8a1 1 0 11-2 0V3zm10 10a1 1 0 011-1h2.586l-3.293-3.293a1 1 0 111.414-1.414L18 10.586V8a1 1 0 112 0v4a1 1 0 01-1 1h-4a1 1 0 110-2z" clip-rule="evenodd" />
                        </svg>
                    </button>
                    <button id="aiCloseButton" class="text-white hover:text-gray-200 focus:outline-none">
                        <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" viewBox="0 0 20 20" fill="currentColor">
                            <path fill-rule="evenodd" d="M4.293 4.293a1 1 0 011.414 0L10 8.586l4.293-4.293a1 1 0 111.414 1.414L11.414 10l4.293 4.293a1 1 0 01-1.414 1.414L10 11.414l-4.293 4.293a1 1 0 01-1.414-1.414L8.586 10 4.293 5.707a1 1 0 010-1.414z" clip-rule="evenodd" />
                        </svg>
                    </button>
                </div>
            </div>
            <div id="aiChatMessages" class="flex-1 p-4 overflow-y-auto bg-gray-50"></div>
            <div id="aiTypingIndicator" class="hidden px-4 py-2 bg-gray-100 text-sm text-gray-500">AI is typing...</div>
            <div class="px-4 pb-4 pt-3 border-t border-gray-200 bg-white">
                <div class="flex space-x-2">
                    <input type="text" id="aiChatInput" placeholder="Type your question..." 
                           class="flex-1 border border-gray-300 rounded-lg px-4 py-2 focus:outline-none focus:ring-2 focus:ring-purple-500 focus:border-transparent">
                    <button id="aiSendButton" class="bg-purple-600 hover:bg-purple-700 text-white px-4 py-2 rounded-lg font-medium transition-colors whitespace-nowrap">
                        Send
                    </button>
                </div>
                <p class="text-xs text-gray-500 mt-2">Ask me anything about {{ product.name }}</p>
            </div>
        </div>

        <!-- Floating Back to Top Button -->
        <button id="backToTopRight" aria-label="Back to top" class="fixed bottom-6 right-24 w-14 h-14 bg-gray-700 hover:bg-gray-800 text-white rounded-full shadow-lg flex items-center justify-center transition-all duration-200 focus:outline-none focus:ring-2 focus:ring-gray-500 focus:ring-offset-2 z-40" title="Back to top">
            <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 15l7-7 7 7" />
            </svg>
        </button>
    </div>
</div>

<!-- Add chat.js script -->
<script src="{% static 'js/chat.js' %}"></script>
<script>
// Initialize AI Chat when DOM is loaded
document.addEventListener('DOMContentLoaded', function() {
    const chat = new ProductChat({
        productId: {{ product.id }},
        variationId: null, // No variation ID for product chat
        chatButtonId: 'aiChatButton',
        chatContainerId: 'aiChatContainer',
        closeButtonId: 'aiCloseButton',
        chatMessagesId: 'aiChatMessages',
        chatInputId: 'aiChatInput',
        sendButtonId: 'aiSendButton',
        typingIndicatorId: 'aiTypingIndicator',
        unreadBadgeId: 'aiUnreadBadge'
    });

    // Toggle FAB menu (radial)
    const mainFab = document.getElementById('mainFab');
    const fabIcon = document.getElementById('fabIcon');
    const fabContainer = document.getElementById('fabContainer');
    let isMenuOpen = false;

    function toggleFabMenu() {
        isMenuOpen = !isMenuOpen;
        fabContainer.classList.toggle('open', isMenuOpen);
        fabIcon.classList.toggle('rotate-45', isMenuOpen);
        mainFab.setAttribute('aria-expanded', isMenuOpen ? 'true' : 'false');
    }

    // Initialize FAB menu
    function initFabMenu() {
        mainFab.addEventListener('click', toggleFabMenu);
        document.addEventListener('click', (e) => {
            if (isMenuOpen && !fabContainer.contains(e.target)) {
                toggleFabMenu();
            }
        });

        // Close menu when any action button is clicked
        document.querySelectorAll('#fabContainer .fab-action').forEach(function(actionEl) {
            actionEl.addEventListener('click', function() {
                if (isMenuOpen) {
                    toggleFabMenu();
                }
            });
        });
    }

    // Initialize when DOM is loaded
    initFabMenu();

    // Expand/collapse AI chat container
    const aiContainer = document.getElementById('aiChatContainer');
    const aiExpandBtn = document.getElementById('aiExpandButton');
    if (aiExpandBtn && aiContainer) {
        aiExpandBtn.addEventListener('click', function(e) {
            e.stopPropagation();
            aiContainer.classList.toggle('ai-expanded');
            // swap icon title
            const isExpanded = aiContainer.classList.contains('ai-expanded');
            aiExpandBtn.title = isExpanded ? 'Restore' : 'Expand';
        });
    }
});
</script>

<style>
/* Radial FAB styles */
.fab-container { position: fixed; bottom: 1.5rem; right: 1.5rem; width: 3.5rem; height: 3.5rem; }
.fab-container #mainFab { position: absolute; bottom: 0; right: 0; z-index: 40; }
.fab-action { position: absolute; bottom: 0.5rem; right: 0.5rem; opacity: 0; transform: translate(0,0) scale(0.9); transition: transform .25s ease, opacity .2s ease; z-index: 30; }
.fab-container.open .fab-action { opacity: 1; transform: scale(1); }
/* Positions (radius ~90px) */
.fab-container.open .fab-action--whatsapp { transform: translate(-65px, -20px); }
.fab-container.open .fab-action--ai { transform: translate(-20px, -70px); }
.fab-container.open .fab-action--seller { transform: translate(-85px, -85px); }
/* Tooltips */
.fab-action { position: absolute; }
.fab-tooltip {
    position: absolute;
    right: 3.25rem;
    top: 50%;
    transform: translateY(-50%);
    white-space: nowrap;
    background: rgba(17, 24, 39, 0.95); /* gray-900 */
    color: #fff;
    padding: 0.25rem 0.5rem;
    border-radius: 0.375rem;
    font-size: 0.75rem; /* text-xs */
    box-shadow: 0 10px 15px -3px rgba(0,0,0,.1), 0 4px 6px -4px rgba(0,0,0,.1);
    opacity: 0;
    pointer-events: none;
    transition: opacity .15s ease;
}
.fab-action:hover .fab-tooltip,
.fab-action:focus-visible .fab-tooltip {
    opacity: 1;
}
+.fab-container.open .fab-action .fab-tooltip {
+    opacity: 1;
+}

/* AI chat expanded mode */
#aiChatContainer.ai-expanded {
    width: 90vw;
    height: 80vh;
    right: 5vw;
    bottom: 10vh;
}
+/* Place AI tooltip to the right of its button */
+.fab-action--ai .fab-tooltip { right: auto; left: 3.25rem; }
</style>

<div class="max-w-7xl mx-auto px-4 py-8">
    <div class="grid lg:grid-cols-2 gap-8 items-start">
        <!-- Product Images -->
        <div class="lg:sticky lg:top-0 lg:self-start">
            {% if images %}
                <div class="mb-4">
                    <img src="{{ images.first.image.url }}" 
                         alt="{{ product.name }}" 
                         class="w-full h-96 object-cover rounded-lg shadow-lg" 
                         id="main-image">
                </div>
                
                {% if images.count > 1 %}
                <div class="grid grid-cols-4 gap-2">
                    {% for image in images %}
                    <img src="{{ image.image.url }}" 
                         alt="{{ product.name }}" 
                         class="w-full h-20 object-cover rounded-lg cursor-pointer hover:opacity-75 transition-opacity"
                         onclick="changeMainImage('{{ image.image.url }}')">
                    {% endfor %}
                </div>
                {% endif %}
            {% else %}
                <div class="w-full h-96 bg-gray-200 rounded-lg flex items-center justify-center">
                    <svg class="w-24 h-24 text-gray-400" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 16l4.586-4.586a2 2 0 012.828 0L16 16m-2-2l1.586-1.586a2 2 0 012.828 0L20 14m-6-6h.01M6 20h12a2 2 0 002-2V6a2 2 0 00-2-2H6a2 2 0 00-2 2v12a2 2 0 002 2z"/>
                    </svg>
                </div>
            {% endif %}
            
            <!-- Product Servicing -->
            {% if product_servicing %}
            <div class="mt-8">
                <h3 class="text-lg font-semibold text-gray-900 mb-4 flex items-center">
                    <svg class="w-5 h-5 mr-2 text-blue-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 5H7a2 2 0 00-2 2v12a2 2 0 002 2h10a2 2 0 002-2V7a2 2 0 00-2-2h-2M9 5a2 2 0 002 2h2a2 2 0 002-2M9 5a2 2 0 012-2h2a2 2 0 012 2"/>
                    </svg>
                    Product Servicing
                </h3>
                <div class="bg-gradient-to-br from-blue-50 to-indigo-50 rounded-xl shadow-sm p-6 border border-blue-100">
                    <div class="space-y-4">
                        {% if product_servicing.shipping %}
                        <div class="flex items-start">
                            <div class="flex-shrink-0 h-10 w-10 rounded-full bg-white/80 backdrop-blur-sm shadow-sm flex items-center justify-center border border-blue-100">
                                <svg class="h-5 w-5 text-blue-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 5H7a2 2 0 00-2 2v12a2 2 0 002 2h10a2 2 0 002-2V7a2 2 0 00-2-2h-2M9 5a2 2 0 002 2h2a2 2 0 002-2M9 5a2 2 0 012-2h2a2 2 0 012 2"/>
                                </svg>
                            </div>
                            <div class="ml-4">
                                <h4 class="text-sm font-medium text-gray-900">Shipping Agent</h4>
                                <p class="text-sm text-gray-600">{{ product_servicing.shipping.name }}</p>
                                {% if product_servicing.shipping.phone %}
                                <p class="text-xs text-gray-500 mt-1">
                                    <a href="tel:{{ product_servicing.shipping.phone }}" class="text-blue-600 hover:text-blue-800">
                                        <svg class="w-3 h-3 inline-block mr-1" fill="currentColor" viewBox="0 0 20 20">
                                            <path d="M2 3a1 1 0 011-1h2.153a1 1 0 01.986.836l.74 4.435a1 1 0 01-.54 1.06l-1.548.773a11.037 11.037 0 006.105 6.105l.774-1.548a1 1 0 011.059-.54l4.435.74a1 1 0 01.836.986V17a1 1 0 01-1 1h-2C7.82 18 2 12.18 2 5V3z"/>
                                        </svg>
                                        {{ product_servicing.shipping.phone }}
                                    </a>
                                </p>
                                {% endif %}
                            </div>
                        </div>
                        {% endif %}

                        {% if product_servicing.sourcing %}
                        <div class="flex items-start">
                            <div class="flex-shrink-0 h-10 w-10 rounded-full bg-white/80 backdrop-blur-sm shadow-sm flex items-center justify-center border border-green-100">
                                <svg class="h-5 w-5 text-green-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M21 21l-6-6m2-5a7 7 0 11-14 0 7 7 0 0114 0z"/>
                                </svg>
                            </div>
                            <div class="ml-4">
                                <h4 class="text-sm font-medium text-gray-900">Sourcing Agent</h4>
                                <p class="text-sm text-gray-600">{{ product_servicing.sourcing.name }}</p>
                                {% if product_servicing.sourcing.phone %}
                                <p class="text-xs text-gray-500 mt-1">
                                    <a href="tel:{{ product_servicing.sourcing.phone }}" class="text-blue-600 hover:text-blue-800">
                                        <svg class="w-3 h-3 inline-block mr-1" fill="currentColor" viewBox="0 0 20 20">
                                            <path d="M2 3a1 1 0 011-1h2.153a1 1 0 01.986.836l.74 4.435a1 1 0 01-.54 1.06l-1.548.773a11.037 11.037 0 006.105 6.105l.774-1.548a1 1 0 011.059-.54l4.435.74a1 1 0 01.836.986V17a1 1 0 01-1 1h-2C7.82 18 2 12.18 2 5V3z"/>
                                        </svg>
                                        {{ product_servicing.sourcing.phone }}
                                    </a>
                                </p>
                                {% endif %}
                            </div>
                        </div>
                        {% endif %}

                        {% if product_servicing.customs %}
                        <div class="flex items-start">
                            <div class="flex-shrink-0 h-10 w-10 rounded-full bg-white/80 backdrop-blur-sm shadow-sm flex items-center justify-center border border-purple-100">
                                <svg class="h-5 w-5 text-purple-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12l2 2 4-4m5.618-4.016A11.955 11.955 0 0112 2.944a11.955 11.955 0 01-8.618 3.04A12.02 12.02 0 003 9c0 5.591 3.824 10.29 9 11.622 5.176-1.332 9-6.03 9-11.622 0-1.042-.133-2.052-.382-3.016z"/>
                                </svg>
                            </div>
                            <div class="ml-4">
                                <h4 class="text-sm font-medium text-gray-900">Customs Agent</h4>
                                <p class="text-sm text-gray-600">{{ product_servicing.customs.name }}</p>
                                {% if product_servicing.customs.phone %}
                                <p class="text-xs text-gray-500 mt-1">
                                    <a href="tel:{{ product_servicing.customs.phone }}" class="text-blue-600 hover:text-blue-800">
                                        <svg class="w-3 h-3 inline-block mr-1" fill="currentColor" viewBox="0 0 20 20">
                                            <path d="M2 3a1 1 0 011-1h2.153a1 1 0 01.986.836l.74 4.435a1 1 0 01-.54 1.06l-1.548.773a11.037 11.037 0 006.105 6.105l.774-1.548a1 1 0 011.059-.54l4.435.74a1 1 0 01.836.986V17a1 1 0 01-1 1h-2C7.82 18 2 12.18 2 5V3z"/>
                                        </svg>
                                        {{ product_servicing.customs.phone }}
                                    </a>
                                </p>
                                {% endif %}
                            </div>
                        </div>
                        {% endif %}
                    </div>
                </div>
            </div>
            {% endif %}
            
            <!-- Additional Fees -->
            {% if additional_fees %}
            <div class="mt-8">
                <h3 class="text-lg font-semibold text-gray-900 mb-4 flex items-center">
                    <svg class="w-5 h-5 mr-2 text-green-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M17 9V7a2 2 0 00-2-2H5a2 2 0 00-2 2v6a2 2 0 002 2h2m2 4h10a2 2 0 002-2v-6a2 2 0 00-2-2H9a2 2 0 00-2 2v6a2 2 0 002 2zm7-5a2 2 0 11-4 0 2 2 0 014 0z"/>
                    </svg>
                    Additional Fees
                </h3>
                <div class="bg-gradient-to-br from-green-50 to-emerald-50 rounded-xl shadow-sm p-6 border border-green-100">
                    <div class="space-y-4">
                        {% for fee in additional_fees %}
                        <div class="flex items-start justify-between p-4 bg-white rounded-lg border border-green-100 hover:shadow-md transition-shadow">
                            <div class="flex items-start">
                                <div class="flex-shrink-0 h-10 w-10 rounded-full bg-green-100 flex items-center justify-center mr-4">
                                    <svg class="h-5 w-5 text-green-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 8c-1.657 0-3 .895-3 2s1.343 2 3 2 3 .895 3 2-1.343 2-3 2m0-8c1.11 0 2.08.402 2.599 1M12 8V7m0 1v8m0 0v1m0-1c-1.11 0-2.08-.402-2.599-1"/>
                                    </svg>
                                </div>
                                <div>
                                    <h4 class="text-sm font-medium text-gray-900 flex items-center">
                                        {{ fee.name }}
                                        {% if fee.is_required %}
                                        <span class="ml-2 px-2 py-1 text-xs font-medium bg-red-100 text-red-800 rounded-full">Required</span>
                                        {% endif %}
                                    </h4>
                                    {% if fee.description %}
                                    <p class="text-sm text-gray-600 mt-1">{{ fee.description }}</p>
                                    {% endif %}
                                    <p class="text-xs text-gray-500 mt-1">
                                        <span class="font-medium">Applies to:</span>
                                        {% for var in fee.variation.all %}
                                            {{ var.name }}{% if not forloop.last %}, {% endif %}
                                        {% endfor %}
                                    </p>
                                </div>
                            </div>
                            <div class="text-right">
                                <div class="text-lg font-semibold text-green-600">KSh {{ fee.price|floatformat:2 }}</div>
                                <div class="text-xs text-gray-500">per item</div>
                            </div>
                        </div>
                        {% endfor %}
                    </div>
                </div>
            </div>
            {% endif %}
        </div>
        
        <!-- Product Details -->
        <div>
            <div class="relative mb-8">
                <h1 class="text-4xl product-title text-gray-900 mb-3">
                    {{ product.name }}
                </h1>
                <div class="absolute -bottom-1 left-0 w-20 h-1.5 bg-gradient-to-r from-blue-600 to-indigo-600 rounded-full transform transition-all duration-300 hover:w-24"></div>
            </div>
            
            <!-- Vendor Info -->
            <div class="flex items-center mb-4">
                <div class="w-10 h-10 bg-blue-100 rounded-full flex items-center justify-center mr-3">
                    <svg class="w-6 h-6 text-blue-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 21V5a2 2 0 00-2-2H7a2 2 0 00-2 2v16m14 0h2m-2 0h-5m-9 0H3m2 0h5M9 7h1m-1 4h1m4-4h1m-1 4h1m-5 10v-5a1 1 0 011-1h2a1 1 0 011 1v5m-4 0h4"/>
                    </svg>
                </div>
                <div>
                    <p class="text-sm text-gray-600">Sold by</p>
                    <p class="font-semibold text-gray-900">{{ product.business.name }}</p>
                </div>
            </div>
            
            <!-- Price and MOQ -->
            <div class="bg-gray-50 rounded-lg p-6 mb-6" id="priceCard" data-moq="{{ product.moq }}" data-price="0" data-price-single="0" data-has-variations="{% if product.variations.all|length %}1{% else %}0{% endif %}">
                <div class="flex items-center justify-between mb-3">
                    <div>
                        <div class="text-gray-500 text-sm" id="priceTierLabel">Unit price</div>
                        <div class="text-4xl font-bold text-blue-600">
                            {% if variation_min_price and variation_max_price %}
                                Ksh{{ variation_min_price }}{% if variation_max_price != variation_min_price %} - Ksh{{ variation_max_price }}{% endif %}
                            {% else %}
                                Ksh<span id="unit-price">0.00</span>
                            {% endif %}
                        </div>
                    </div>
                    <span class="text-sm text-gray-500 bg-white px-3 py-1 rounded-full">
                        {% with cats=product.categories.all %}
                            {% if cats %}
                                {% for c in cats %}{{ c.name }}{% if not forloop.last %}, {% endif %}{% endfor %}
                            {% endif %}
                        {% endwith %}
                    </span>
                </div>
                {% if False %}
                <div class="grid grid-cols-1 sm:grid-cols-2 gap-3 mt-2 text-sm">
                    <div class="bg-white rounded-lg border border-gray-200 p-3">
                        <div class="text-gray-500">When buying ≥ MOQ ({{ product.moq }})</div>
                        <div class="font-semibold text-gray-900">Ksh0.00</div>
                    </div>
                    <div class="bg-white rounded-lg border border-gray-200 p-3">
                        <div class="text-gray-500">When buying less than MOQ</div>
                        <div class="font-semibold text-gray-900">Ksh0.00</div>
                    </div>
                </div>
                {% endif %}
                <div class="flex items-center justify-between text-sm text-gray-600 mt-4">
                    <span>Minimum Order Quantity (MOQ):</span>
                    <span class="font-semibold">{{ product.moq }} units</span>
                </div>
            </div>

            <!-- Purchase Options -->
            <div class="bg-white rounded-lg shadow p-6 mb-6">
                <div class="grid sm:grid-cols-2 gap-4">
                    {% if not product.variations.all %}
                    <form method="post" action="{% url 'home:add_to_cart' %}" class="contents">
                        {% csrf_token %}
                        <input type="hidden" name="product_id" value="{{ product.id }}" />
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-2">Quantity</label>
                            <div class="flex items-center">
                                <input name="quantity" type="number" min="{{ product.moq }}" value="{{ product.moq }}" class="w-28 border border-gray-300 rounded-lg px-3 py-2 focus:outline-none focus:ring-2 focus:ring-blue-500" />
                                <span class="ml-3 text-sm text-gray-500">units (MOQ {{ product.moq }})</span>
                            </div>
                        </div>
                        <div class="sm:col-span-2 mt-6 flex flex-col sm:flex-row gap-3">
                            <input type="hidden" name="next" value="{{ request.get_full_path }}" />
                            <button type="submit" class="flex-1 bg-blue-600 text-white py-3 px-6 rounded-lg font-semibold hover:bg-blue-700 transition-colors">
                                <svg class="w-5 h-5 inline mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M3 3h2l.4 2M7 13h10l4-8H5.4M7 13L5.4 5M7 13l-2 9m5-9v9m4-9v9m4-9l2 9"/>
                                </svg>
                                Add to Cart
                            </button>
                        </div>
                    </form>
                    {% endif %}

                    {% if product.variations.all %}
                    <div class="sm:col-span-2">
                        <h3 class="text-md font-semibold text-gray-900 mb-3">Available Variations</h3>
                        <div class="space-y-3">
                            {% for v in product.variations.all %}
                            <form method="post" action="{% url 'home:add_to_cart' %}" class="gap-4 rounded-xl border border-gray-200 bg-white hover:shadow-md transition-shadow duration-200 p-5">
                                {% csrf_token %}
                                <input type="hidden" name="product_id" value="{{ product.id }}" />
                                <input type="hidden" name="variation_id" value="{{ v.id }}" />
                                <div class="flex flex-col lg:flex-row lg:items-center lg:justify-between gap-4">
                                    <div>
                                        <div class="variation-title text-gray-900 text-lg">
                                            <a href="{% url 'home:variation_detail' v.id %}" class="text-gray-900 hover:text-blue-600 transition-colors duration-200">{{ v.name }}</a>
                                        </div>
                                        <div class="text-sm text-gray-600 mt-1">
                                            <span class="font-medium">Ksh{{ v.price }}</span> • MOQ: {{ v.moq }}
                                        </div>
                                        <a href="{% url 'home:variation_detail' v.id %}" class="inline-flex items-center text-sm text-blue-600 hover:text-blue-800 mt-1 group transition-colors duration-200">
                                            View details
                                            <svg class="w-3.5 h-3.5 ml-1 opacity-0 group-hover:opacity-100 group-hover:translate-x-1 transform transition-all duration-200" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 5l7 7-7 7"/>
                                            </svg>
                                        </a>
                                    </div>
                                    <div class="flex items-center gap-2">
                                        <label for="qty_{{ v.id }}" class="sr-only">Quantity</label>
                                        <input id="qty_{{ v.id }}" name="quantity" type="number" min="{{ v.moq }}" value="{{ v.moq }}" class="w-24 border border-gray-300 rounded-lg px-3 py-2 focus:outline-none focus:ring-2 focus:ring-blue-500" />
                                        <input type="hidden" name="next" value="{{ request.get_full_path }}" />
                                        {% if cart_variation_ids and v.id in cart_variation_ids %}
                                            <button type="button" disabled class="bg-green-50 text-green-700 px-4 py-2 rounded-lg font-semibold">
                                                <svg class="w-4 h-4 inline mr-1" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 13l4 4L19 7"/></svg>
                                                In cart
                                            </button>
                                        {% else %}
                                            <button type="submit" class="bg-blue-600 text-white px-4 py-2 rounded-lg font-semibold hover:bg-blue-700">Add</button>
                                        {% endif %}
                                    </div>
                                </div>

                                {% with tiers=v.price_tiers.all %}
                                {% if tiers %}
                                <div class="mt-4 rounded-lg bg-white p-4">
                                    <div class="mb-2 text-sm font-medium text-gray-900">Bulk Pricing</div>
                                    <div class="overflow-x-auto">
                                        <table class="min-w-full text-left text-sm">
                                            <thead>
                                                <tr class="text-gray-500">
                                                    <th class="py-2 pr-4">Quantity Range</th>
                                                    <th class="py-2 pr-4">Unit Price</th>
                                                </tr>
                                            </thead>
                                            <tbody class="divide-y divide-gray-100">
                                                {% for t in tiers %}
                                                <tr>
                                                    <td class="py-2 pr-4 text-gray-700">{{ t.min_quantity }}{% if t.max_quantity %} - {{ t.max_quantity }}{% else %}+{% endif %}</td>
                                                    <td class="py-2 pr-4 font-semibold text-gray-900">Ksh{{ t.price }}</td>
                                                </tr>
                                                {% endfor %}
                                            </tbody>
                                        </table>
                                    </div>
                                </div>
                                {% endif %}
                                {% endwith %}
                            </form>
                            {% endfor %}
                        </div>
                    </div>
                    {% endif %}
                    <button onclick="openOrderModal()" class="w-full bg-indigo-600 text-white py-3 px-6 rounded-lg font-semibold hover:bg-indigo-700 transition-colors sm:col-span-2 mt-3">
                        Commit to Order
                    </button>
                </div>
                <div class="mt-6 flex flex-col sm:flex-row gap-3">
                    <!-- Chat with Seller Button -->
                    {% if request.user.is_authenticated and request.user != product.user %}
                    <a href="{% url 'home:start_chat' product.user.id %}?product_id={{ product.id }}"
                       class="flex-1 bg-blue-600 text-white py-3 px-6 rounded-lg font-semibold text-center hover:bg-blue-700 transition-colors">
                        <svg class="w-5 h-5 inline mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8 12h.01M12 12h.01M16 12h.01M21 12c0 4.418-4.03 8-9 8a9.863 9.863 0 01-4.255-.949L3 20l1.395-3.72C3.512 15.042 3 13.574 3 12c0-4.418 4.03-8 9-8s9 3.582 9 8z" />
                        </svg>
                        Chat with Seller
                    </a>
                                        {% else %}
                    <a href="{% url 'login' %}"
                       class="flex-1 bg-blue-600 text-white py-3 px-6 rounded-lg font-semibold text-center hover:bg-blue-700 transition-colors">
                        <svg class="w-5 h-5 inline mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8 12h.01M12 12h.01M16 12h.01M21 12c0 4.418-4.03 8-9 8a9.863 9.863 0 01-4-.8L3 20l.86-3.44A7.963 7.963 0 013 12c0-4.418 4.03-8 9-8s9 3.582 9 8z" />
                        </svg>
                        Login to Chat
                    </a>
                    {% endif %}
                    
                    <!-- WhatsApp Button -->
                    {% if product.business.phone %}
                    {% with msg="Hi "|add:product.business.name|add:", I'm interested in "|add:product.name|add:"." %}
                    <a href="https://wa.me/{{ product.business.phone|cut:' '|cut:'-'|cut:'('|cut:')' }}?text={{ msg|urlencode }}"
                       target="_blank"
                       rel="noopener"
                       class="flex-1 bg-green-600 text-white py-3 px-6 rounded-lg font-semibold text-center hover:bg-green-700 transition-colors">
                        <svg class="w-5 h-5 inline mr-2" viewBox="0 0 32 32" fill="currentColor" aria-hidden="true">
                            <path d="M19.11 17.24a5.51 5.51 0 0 1-2.44-2.44c-.22-.47-.11-.78.1-1l.24-.25c.19-.19.25-.5.14-.76l-.72-1.75c-.21-.5-.7-.82-1.24-.82a3.6 3.6 0 0 0-2.56 1.2 3.68 3.68 0 0 0-.93 2.59c0 2.5 2.27 5.39 5.2 6.56.62.25 1.18.41 1.68.52.26.06.53-.03.72-.22l1.02-1.03c.2-.2.3-.5.22-.78l-.45-1.62c-.07-.25-.3-.44-.58-.49l-.34-.06c-.2-.03-.41.03-.56.17l-.28.28c-.2.2-.52.31-.99.1Z"/>
                            <path d="M16 3C9.375 3 4 8.375 4 15c0 2.15.567 4.167 1.558 5.917L4 29l8.292-1.525A11.88 11.88 0 0 0 16 27c6.625 0 12-5.375 12-12S22.625 3 16 3Zm0 22a9.93 9.93 0 0 1-5.08-1.392l-.364-.219-4.058 .747.747-4.058-.22-.364A9.93 9.93 0 0 1 6 15c0-5.523 4.477-10 10-10s10 4.477 10 10-4.477 10-10 10Z"/>
                        </svg>
                        WhatsApp
                    </a>
                    {% endwith %}
                    {% elif product.business.email %}
                    <a href="mailto:{{ product.business.email }}?subject=Inquiry about {{ product.name }}" class="flex-1 bg-green-600 text-white py-3 px-6 rounded-lg font-semibold text-center hover:bg-green-700 transition-colors">
                        <svg class="w-5 h-5 inline mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8 10h.01M12 10h.01M16 10h.01M21 12c0 4.418-4.03 8-9 8a9.863 9.863 0 01-4-.8L3 20l.86-3.44A7.963 7.963 0 013 12c0-4.418 4.03-8 9-8s9 3.582 9 8z"/>
                        </svg>
                        Chat Now
                    </a>
                    {% endif %}
                </div>
            </div>
            
            {% if request.user.is_authenticated and my_orders %}
            <!-- Your Orders for this Product -->
            <div class="mb-6">
                <h3 class="text-lg font-semibold text-gray-900 mb-3">Your Orders for this Product</h3>
                <div class="space-y-3">
                    {% for o in my_orders %}
                    <div class="flex items-center justify-between bg-white border border-gray-200 rounded-lg p-4">
                        <div>
                            <div class="text-sm text-gray-500">Order #{{ o.id }} • {{ o.created_at|date:"M d, Y H:i" }}</div>
                            <div class="text-sm text-gray-700">Qty: <span class="font-semibold">{{ o.quantity }}</span></div>
                            {% if o.note %}
                            <div class="text-xs text-gray-500 mt-1">{{ o.note|linebreaksbr }}</div>
                            {% endif %}
                        </div>
                        <div class="flex items-center gap-3">
                            <span class="px-2 py-1 rounded-full text-xs font-medium {% if o.status == 'confirmed' %}bg-green-100 text-green-700{% elif o.status == 'pending' %}bg-yellow-100 text-yellow-800{% elif o.status == 'cancelled' %}bg-red-100 text-red-700{% else %}bg-gray-100 text-gray-700{% endif %}">{{ o.status|title }}</span>
                            {% if o.status == 'pending' %}
                            <a href="{% url 'home:product_order_payment' o.id %}" class="inline-flex items-center bg-indigo-600 text-white px-3 py-2 rounded-md text-sm font-medium hover:bg-indigo-700">Confirm</a>
                            {% endif %}
                        </div>
                    </div>
                    {% endfor %}
                </div>
            </div>
            {% endif %}

            <!-- Order History Tabs -->
            <div class="mb-8">
                <div class="flex items-center justify-between mb-6">
                    <h3 class="text-xl font-semibold text-gray-900">Order History</h3>
                </div>
                
                <!-- Tabs Navigation -->
                <div class="border-b border-gray-200 mb-6">
                    <nav class="-mb-px flex space-x-8" aria-label="Tabs">
                        <button onclick="showTab('orders-tab', 'orders-content', this)" 
                                class="whitespace-nowrap py-4 px-1 border-b-2 font-medium text-sm border-blue-500 text-blue-600">
                            Orders ({{ related_orders.count }})
                        </button>
                        <button onclick="showTab('requests-tab', 'requests-content', this)" 
                                class="whitespace-nowrap py-4 px-1 border-b-2 font-medium text-sm border-transparent text-gray-500 hover:text-gray-700 hover:border-gray-300">
                            Order Requests ({{ related_order_requests|length }})
                        </button>
                    </nav>
                </div>
                
                <!-- Orders Tab Content -->
                <div id="orders-content" class="space-y-4">
                    {% if related_orders %}
                        {% for order in related_orders %}
                        <div class="bg-white shadow overflow-hidden sm:rounded-lg">
                            <div class="px-4 py-5 sm:px-6 flex justify-between items-center">
                                <div>
                                    <h4 class="text-lg leading-6 font-medium text-gray-900">
                                        Order #{{ order.id }} - {{ order.get_status_display }}
                                    </h4>
                                    <p class="mt-1 max-w-2xl text-sm text-gray-500">
                                        {{ order.created_at|date:"F j, Y" }}
                                    </p>
                                </div>
                                <span class="px-2.5 py-0.5 rounded-full text-xs font-medium {% if order.status == 'completed' %}bg-green-100 text-green-800{% elif order.status == 'cancelled' %}bg-red-100 text-red-800{% else %}bg-yellow-100 text-yellow-800{% endif %}">
                                    {{ order.get_status_display }}
                                </span>
                            </div>
                            <div class="border-t border-gray-200 px-4 py-5 sm:p-0">
                                <dl class="sm:divide-y sm:divide-gray-200">
                                    {% for item in order.product_items %}
                                    <div class="py-4 sm:py-5 sm:grid sm:grid-cols-3 sm:gap-4 sm:px-6">
                                        <dt class="text-sm font-medium text-gray-500">Product</dt>
                                        <dd class="mt-1 text-sm text-gray-900 sm:mt-0 sm:col-span-2">
                                            {{ item.variation.product.name }} - {{ item.variation.name }}
                                        </dd>
                                    </div>
                                    <div class="py-4 sm:py-5 sm:grid sm:grid-cols-3 sm:gap-4 sm:px-6">
                                        <dt class="text-sm font-medium text-gray-500">Quantity</dt>
                                        <dd class="mt-1 text-sm text-gray-900 sm:mt-0 sm:col-span-2">{{ item.quantity }}</dd>
                                    </div>
                                    <div class="py-4 sm:py-5 sm:grid sm:grid-cols-3 sm:gap-4 sm:px-6">
                                        <dt class="text-sm font-medium text-gray-500">Price</dt>
                                        <dd class="mt-1 text-sm text-gray-900 sm:mt-0 sm:col-span-2">KSh {{ item.price|intcomma }}</dd>
                                    </div>
                                    <div class="py-4 sm:py-5 sm:grid sm:grid-cols-3 sm:gap-4 sm:px-6">
                                        <dt class="text-sm font-medium text-gray-500">Total</dt>
                                        <dd class="mt-1 text-sm font-semibold text-gray-900 sm:mt-0 sm:col-span-2">
                                            KSh {{ item.subtotal|intcomma }}
                                        </dd>
                                    </div>
                                    {% if not forloop.last %}<hr class="my-4">{% endif %}
                                    {% endfor %}
                                </dl>
                            </div>
                        </div>
                        {% endfor %}
                    {% else %}
                        <div class="text-center py-12 bg-gray-50 rounded-lg">
                            <svg class="mx-auto h-12 w-12 text-gray-400" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 5H7a2 2 0 00-2 2v12a2 2 0 002 2h10a2 2 0 002-2V7a2 2 0 00-2-2h-2M9 5a2 2 0 002 2h2a2 2 0 002-2M9 5a2 2 0 012-2h2a2 2 0 012 2" />
                            </svg>
                            <h3 class="mt-2 text-sm font-medium text-gray-900">No orders found</h3>
                            <p class="mt-1 text-sm text-gray-500">There are no orders for this product yet.</p>
                        </div>
                    {% endif %}
                </div>
                
                <!-- Order Requests Tab Content -->
                <div id="requests-content" class="hidden space-y-4">
                    {% if related_order_requests %}
                        {% for request_data in related_order_requests.values %}
                        <div class="bg-white shadow overflow-hidden sm:rounded-lg">
                            <div class="px-4 py-5 sm:px-6 flex justify-between items-center">
                                <div>
                                    <h4 class="text-lg leading-6 font-medium text-gray-900">
                                        Order Request #{{ request_data.order_request.id }} - {{ request_data.order_request.get_status_display }}
                                    </h4>
                                    <p class="mt-1 max-w-2xl text-sm text-gray-500">
                                        {{ request_data.order_request.created_at|date:"F j, Y" }}
                                    </p>
                                </div>
                                <span class="px-2.5 py-0.5 rounded-full text-xs font-medium 
                                    {% if request_data.order_request.status == 'accepted' %}bg-green-100 text-green-800
                                    {% elif request_data.order_request.status == 'rejected' %}bg-red-100 text-red-800
                                    {% else %}bg-yellow-100 text-yellow-800{% endif %}">
                                    {{ request_data.order_request.get_status_display }}
                                </span>
                            </div>
                            <div class="border-t border-gray-200">
                                {% for item in request_data.items %}
                                <div class="px-4 py-5 sm:p-0 border-b border-gray-100 last:border-0">
                                    <dl class="sm:divide-y sm:divide-gray-200">
                                        <div class="py-4 sm:py-5 sm:grid sm:grid-cols-3 sm:gap-4 sm:px-6">
                                            <dt class="text-sm font-medium text-gray-500">Product</dt>
                                            <dd class="mt-1 text-sm text-gray-900 sm:mt-0 sm:col-span-2">
                                                {{ item.variation.product.name }} - 
                                                {% for attr in item.variation.attributes.all %}
                                                    {{ attr.attribute.name }}: {{ attr.value.value }}{% if not forloop.last %}, {% endif %}
                                                {% endfor %}
                                            </dd>
                                        </div>
                                        <div class="py-4 sm:py-5 sm:grid sm:grid-cols-3 sm:gap-4 sm:px-6">
                                            <dt class="text-sm font-medium text-gray-500">Requested Quantity</dt>
                                            <dd class="mt-1 text-sm text-gray-900 sm:mt-0 sm:col-span-2">{{ item.quantity }}</dd>
                                        </div>
                                        <div class="py-4 sm:py-5 sm:grid sm:grid-cols-3 sm:gap-4 sm:px-6">
                                            <dt class="text-sm font-medium text-gray-500">Proposed Price</dt>
                                            <dd class="mt-1 text-sm text-gray-900 sm:mt-0 sm:col-span-2">KSh {{ item.unit_price|intcomma }}</dd>
                                        </div>
                                        {% if item.deposit_percentage > 0 %}
                                        <div class="py-4 sm:py-5 sm:grid sm:grid-cols-3 sm:gap-4 sm:px-6">
                                            <dt class="text-sm font-medium text-gray-500">Deposit</dt>
                                            <dd class="mt-1 text-sm text-gray-900 sm:mt-0 sm:col-span-2">
                                                {{ item.deposit_percentage|floatformat:0 }}% (KSh {{ item.deposit_amount|intcomma }})
                                            </dd>
                                        </div>
                                        {% endif %}
                                        <div class="py-4 sm:py-5 sm:grid sm:grid-cols-3 sm:gap-4 sm:px-6">
                                            <dt class="text-sm font-medium text-gray-500">Item Total</dt>
                                            <dd class="mt-1 text-sm font-semibold text-gray-900 sm:mt-0 sm:col-span-2">
                                                KSh {{ item.subtotal|intcomma }}
                                            </dd>
                                        </div>
                                    </dl>
                                </div>
                                {% endfor %}
                                <!-- Order Request Footer with Totals -->
                                <div class="bg-gray-50 px-4 py-4 sm:px-6 sm:flex sm:flex-row-reverse">
                                    <div class="mt-4 sm:mt-0 sm:ml-4">
                                        <dt class="text-sm font-medium text-gray-500">Order Total</dt>
                                        <dd class="text-lg font-bold text-gray-900">KSh {{ request_data.total|intcomma }}</dd>
                                        {% if request_data.deposit_total > 0 %}
                                        <div class="mt-1">
                                            <dt class="text-sm font-medium text-gray-500">Total Deposit</dt>
                                            <dd class="text-md font-semibold text-gray-700">KSh {{ request_data.deposit_total|intcomma }}</dd>
                                        </div>
                                        {% endif %}
                                    </div>
                                </div>
                            </div>
                        </div>
                        {% endfor %}
                    {% else %}
                        <div class="text-center py-12 bg-gray-50 rounded-lg">
                            <svg class="mx-auto h-12 w-12 text-gray-400" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 5H7a2 2 0 00-2 2v12a2 2 0 002 2h10a2 2 0 002-2V7a2 2 0 00-2-2h-2M9 5a2 2 0 002 2h2a2 2 0 002-2M9 5a2 2 0 012-2h2a2 2 0 012 2" />
                            </svg>
                            <h3 class="mt-2 text-sm font-medium text-gray-900">No order requests found</h3>
                            <p class="mt-1 text-sm text-gray-500">There are no order requests for this product yet.</p>
                        </div>
                    {% endif %}
                </div>
            </div>

            {% if request.user.is_authenticated and my_payments %}
            <!-- Your Payments for this Product -->
            <div class="mb-6">
                <h3 class="text-lg font-semibold text-gray-900 mb-3">Your Payments for this Product</h3>
                <div class="space-y-3">
                    {% for p in my_payments %}
                    {% with rp=p.raw_payment %}
                    <div class="flex items-center justify-between bg-white border border-gray-200 rounded-lg p-4">
                        <div>
                            <div class="text-sm text-gray-500">Payment • {{ p.created_at|date:"M d, Y H:i" }}</div>
                            <div class="text-sm text-gray-700">Amount: <span class="font-semibold">{{ rp.amount }} {{ rp.currency }}</span></div>
                            <div class="text-xs text-gray-500 mt-1">Method: {{ rp.payment_method|title }}{% if rp.phone_number %} • Phone: {{ rp.phone_number }}{% endif %}</div>
                        </div>
                        <span class="px-2 py-1 rounded-full text-xs font-medium {% if rp.status == 'completed' %}bg-green-100 text-green-700{% elif rp.status == 'pending' %}bg-yellow-100 text-yellow-800{% elif rp.status == 'failed' %}bg-red-100 text-red-700{% elif rp.status == 'refunded' %}bg-purple-100 text-purple-700{% else %}bg-gray-100 text-gray-700{% endif %}">{{ rp.status|title }}</span>
                    </div>
                    {% endwith %}
                    {% endfor %}
                </div>
            </div>
            {% endif %}

            <!-- Description -->
            <div class="mb-6">
                <h3 class="text-lg font-semibold text-gray-900 mb-3">Description</h3>
                <p class="text-gray-700 leading-relaxed">{{ product.description|linebreaks }}</p>
            </div>

            <!-- Ratings & Reviews -->
            <div class="mb-8">
                <div class="flex items-center justify-between mb-4">
                    <h3 class="text-lg font-semibold text-gray-900">Ratings & Reviews</h3>
                    <span class="text-sm text-gray-500">{{ product.reviews.count }} review{{ product.reviews.count|pluralize }}</span>
                </div>
                {% if product.reviews.all %}
                <div class="space-y-4">
                    {% for review in product.reviews.all|slice:":5" %}
                    <div class="bg-white rounded-lg border border-gray-100 p-4">
                        <div class="flex items-center justify-between mb-1">
                            <div class="flex items-center">
                                {% for i in "12345" %}
                                    {% if forloop.counter <= review.rating %}
                                        <svg class="w-4 h-4 text-yellow-400" fill="currentColor" viewBox="0 0 20 20"><path d="M9.049 2.927c.3-.921 1.603-.921 1.902 0l1.07 3.292a1 1 0 00.95.69h3.462c.969 0 1.371 1.24.588 1.81l-2.802 2.034a1 1 0 00-.364 1.118l1.07 3.292c.3.921-.755 1.688-1.54 1.118l-2.802-2.034a1 1 0 00-1.175 0l-2.802 2.034c-.784.57-1.838-.197-1.539-1.118l1.07-3.292a1 1 0 00-.364-1.118L2.98 8.72c-.783-.57-.38-1.81.588-1.81h3.461a1 1 0 00.951-.69l1.07-3.292z"/></svg>
                                    {% else %}
                                        <svg class="w-4 h-4 text-gray-300" fill="currentColor" viewBox="0 0 20 20"><path d="M9.049 2.927c.3-.921 1.603-.921 1.902 0l1.07 3.292a1 1 0 00.95.69h3.462c.969 0 1.371 1.24.588 1.81l-2.802 2.034a1 1 0 00-.364 1.118l1.07 3.292c.3.921-.755 1.688-1.54 1.118l-2.802-2.034a1 1 0 00-1.175 0l-2.802 2.034c-.784.57-1.838-.197-1.539-1.118l1.07-3.292a1 1 0 00-.364-1.118L2.98 8.72c-.783-.57-.38-1.81.588-1.81h3.461a1 1 0 00.951-.69l1.07-3.292z"/></svg>
                                    {% endif %}
                                {% endfor %}
                            </div>
                            <span class="text-xs text-gray-400">{{ review.created_at|date:"M d, Y" }}</span>
                        </div>
                        {% if review.comment %}
                        <p class="text-sm text-gray-700">{{ review.comment }}</p>
                        {% endif %}
                    </div>
                    {% endfor %}
                </div>
                {% else %}
                <div class="bg-gray-50 rounded-lg p-6 text-center text-gray-500">No reviews yet.</div>
                {% endif %}
            </div>
            
            <!-- Contact Vendor -->
            <div class="bg-blue-50 rounded-lg p-6 mb-6">
                <h3 class="text-lg font-semibold text-gray-900 mb-3">Interested in this product?</h3>
                <p class="text-gray-600 mb-4">Contact the vendor directly for more information, custom pricing, or to place an order.</p>
                
                <div class="space-y-3">
                    {% if product.business.phone %}
                    <div class="flex items-center">
                        <svg class="w-5 h-5 text-blue-600 mr-3" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M3 5a2 2 0 012-2h3.28a1 1 0 01.948.684l1.498 4.493a1 1 0 01-.502 1.21l-2.257 1.13a11.042 11.042 0 005.516 5.516l1.13-2.257a1 1 0 011.21-.502l4.493 1.498a1 1 0 01.684.949V19a2 2 0 01-2 2h-1C9.716 21 3 14.284 3 6V5z"/>
                        </svg>
                        <a href="tel:{{ product.business.phone }}" class="text-blue-600 hover:text-blue-800">{{ product.business.phone }}</a>
                    </div>
                    {% endif %}
                    
                    {% if product.business.email %}
                    <div class="flex items-center">
                        <svg class="w-5 h-5 text-blue-600 mr-3" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M3 8l7.89 4.26a2 2 0 002.22 0L21 8M5 19h14a2 2 0 002-2V7a2 2 0 00-2-2H5a2 2 0 00-2 2v10a2 2 0 002 2z"/>
                        </svg>
                        <a href="mailto:{{ product.business.email }}" class="text-blue-600 hover:text-blue-800">{{ product.business.email }}</a>
                    </div>
                    {% endif %}
                    
                    {% if product.business.website %}
                    <div class="flex items-center">
                        <svg class="w-5 h-5 text-blue-600 mr-3" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M10 6H6a2 2 0 00-2 2v10a2 2 0 002 2h10a2 2 0 002-2v-4M14 4h6m0 0v6m0-6L10 14"/>
                        </svg>
                        <a href="{{ product.business.website }}" target="_blank" class="text-blue-600 hover:text-blue-800">{{ product.business.website }}</a>
                    </div>
                    {% endif %}
                </div>
            </div>
            
            <!-- Action Buttons -->
            <div class="flex space-x-4">
                <button class="flex-1 bg-blue-600 text-white py-3 px-6 rounded-lg font-semibold hover:bg-blue-700 transition-colors">
                    <svg class="w-5 h-5 inline mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M3 5a2 2 0 012-2h3.28a1 1 0 01.948.684l1.498 4.493a1 1 0 01-.502 1.21l-2.257 1.13a11.042 11.042 0 005.516 5.516l1.13-2.257a1 1 0 011.21-.502l4.493 1.498a1 1 0 01.684.949V19a2 2 0 01-2 2h-1C9.716 21 3 14.284 3 6V5z"/>
                    </svg>
                    Contact Vendor
                </button>
                
                {% if user.is_authenticated %}
                    {% if wishlist_items %}
                        {% for item in wishlist_items %}
                        <form method="post" action="{% url 'home:remove_from_wishlist' item.id %}" class="flex-1">
                            {% csrf_token %}
                            <button type="submit" class="w-full bg-red-50 text-red-700 py-3 px-6 rounded-lg font-semibold hover:bg-red-100 transition-colors">
                                <svg class="w-5 h-5 inline mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"/>
                                </svg>
                                Remove {{ item.product.name }} from Wishlist
                            </button>
                        </form>
                        {% endfor %}
                    {% else %}
                        {% if default_variation %}
                        <form method="post" action="{% url 'home:add_to_wishlist' %}" class="flex-1">
                            {% csrf_token %}
                            <input type="hidden" name="variation_id" value="{{ default_variation.id }}" />
                            <button type="submit" class="w-full bg-gray-100 text-gray-700 py-3 px-6 rounded-lg font-semibold hover:bg-gray-200 transition-colors">
                                <svg class="w-5 h-5 inline mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4.318 6.318a4.5 4.5 0 000 6.364L12 20.364l7.682-7.682a4.5 4.5 0 00-6.364-6.364L12 7.636l-1.318-1.318a4.5 4.5 0 00-6.364 0z"/>
                                </svg>
                                Save for Later
                            </button>
                        </form>
                        {% else %}
                        <button type="button" disabled class="w-full bg-gray-100 text-gray-400 py-3 px-6 rounded-lg font-semibold cursor-not-allowed">
                            <svg class="w-5 h-5 inline mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4.318 6.318a4.5 4.5 0 000 6.364L12 20.364l7.682-7.682a4.5 4.5 0 00-6.364-6.364L12 7.636l-1.318-1.318a4.5 4.5 0 00-6.364 0z"/>
                            </svg>
                            No variations available
                        </button>
                        {% endif %}
                    {% endif %}
                {% else %}
                <a href="{% url 'login' %}" class="flex-1 bg-gray-100 text-gray-700 py-3 px-6 rounded-lg font-semibold hover:bg-gray-200 transition-colors text-center">Save for Later</a>
                {% endif %}
            </div>
        </div>
    </div>
    
    <!-- Related Products -->
    {% if related_products %}
    <div class="mt-16">
        <h2 class="text-2xl font-bold text-gray-900 mb-6">Related Products</h2>
        <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-6">
            {% for related_product in related_products %}
            <div class="bg-white rounded-lg shadow-md hover:shadow-lg transition-shadow duration-300 overflow-hidden">
                <div class="aspect-w-16 aspect-h-12 bg-gray-200">
                    {% if related_product.images.first %}
                        <img src="{{ related_product.images.first.image.url }}" 
                             alt="{{ related_product.name }}" 
                             class="w-full h-48 object-cover">
                    {% else %}
                        <div class="w-full h-48 bg-gray-200 flex items-center justify-center">
                            <svg class="w-16 h-16 text-gray-400" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 16l4.586-4.586a2 2 0 012.828 0L16 16m-2-2l1.586-1.586a2 2 0 012.828 0L20 14m-6-6h.01M6 20h12a2 2 0 002-2V6a2 2 0 00-2-2H6a2 2 0 00-2 2v12a2 2 0 002 2z"/>
                            </svg>
                        </div>
                    {% endif %}
                </div>
                
                <div class="p-4">
                    <h3 class="text-lg font-semibold text-gray-900 mb-2 line-clamp-2">{{ related_product.name }}</h3>
                    <p class="text-sm text-gray-600 mb-2">{{ related_product.business.name }}</p>
                    
                    <div class="flex items-center justify-between mb-3">
                        <span class="text-xl font-bold text-blue-600">Ksh{{ related_product.price }}</span>
                        <span class="text-sm text-gray-500">MOQ: {{ related_product.moq }}</span>
                    </div>
                    
                    <a href="{% url 'home:product_detail' related_product.pk %}" 
                       class="w-full bg-blue-600 text-white py-2 px-4 rounded-lg text-sm hover:bg-blue-700 transition-colors text-center block">
                        View Details
                    </a>
                </div>
            </div>
            {% endfor %}
        </div>
    </div>
    {% endif %}
</div>

<script>
function changeMainImage(imageUrl) {
    document.getElementById('main-image').src = imageUrl;
}

// Back to top visibility and behavior for window scroll
document.addEventListener('DOMContentLoaded', function () {
    var btn = document.getElementById('backToTopRight');
    if (!btn) return;

    var rafId;
    function toggleBtn() {
        if (rafId) cancelAnimationFrame(rafId);
        rafId = requestAnimationFrame(function () {
            if (window.scrollY > 200) {
                btn.classList.add('show');
            } else {
                btn.classList.remove('show');
            }
        });
    }

    window.addEventListener('scroll', toggleBtn, { passive: true });
    toggleBtn();

    btn.addEventListener('click', function () {
        window.scrollTo({ top: 0, behavior: 'smooth' });
    });
});

// Dynamic unit price switching based on quantity/MOQ
document.addEventListener('DOMContentLoaded', function(){
    var card = document.getElementById('priceCard');
    if (!card) return;
    var moq = parseInt(card.getAttribute('data-moq') || '1', 10);
    var price = parseFloat(card.getAttribute('data-price') || '0');
    var priceSingle = parseFloat(card.getAttribute('data-price-single') || '0');
    var qtyInput = document.querySelector('input[name="quantity"]');
    var unitPriceEl = document.getElementById('unit-price');
    var tierLabel = document.getElementById('priceTierLabel');
    var hasVariations = card.getAttribute('data-has-variations') === '1';

    // If product has variations, we display a price range server-side; don't override it here.
    if (hasVariations) {
        return;
    }
    function updatePrice(){
        var qty = parseInt(qtyInput && qtyInput.value || moq, 10);
        var useSingle = (moq > 1) && priceSingle && qty < moq;
        unitPriceEl.textContent = (useSingle ? priceSingle : price).toFixed(2);
        if (tierLabel) tierLabel.textContent = useSingle ? 'Unit price (below MOQ)' : 'Unit price';
    }
    if (qtyInput) {
        qtyInput.addEventListener('input', updatePrice);
    }
    updatePrice();
});

// AI Chat modal interactions (basic frontend-only placeholder)
document.addEventListener('DOMContentLoaded', function(){
    var aiBtn = document.getElementById('aiChatBtn');
    var modal = document.getElementById('aiChatModal');
    var responseEl = document.getElementById('aiChatResponse');
    function openModal(){ modal.classList.remove('hidden'); }
    function closeModal(){ modal.classList.add('hidden'); }
    document.querySelectorAll('[data-ai-close]').forEach(function(el){ el.addEventListener('click', closeModal); });
    if (aiBtn) aiBtn.addEventListener('click', openModal);
    var sendBtn = document.getElementById('aiSendBtn');
    var q = document.getElementById('aiQuestion');
    if (sendBtn) {
        sendBtn.addEventListener('click', function(){
            var text = (q && q.value || '').trim();
            if (!text) { q && q.focus(); return; }
            // Placeholder: echo back. Integrate backend API later.
            responseEl.classList.remove('hidden');
            responseEl.textContent = 'AI (placeholder): Thanks! We will process your question about "' + text + '" for {{ product.name }}.';
        });
    }
});
</script>

<style>
.line-clamp-2 {
    display: -webkit-box;
    line-clamp: 2;
    -webkit-line-clamp: 2;
    -webkit-box-orient: vertical;
    overflow: hidden;
}
/* Removed independent right-column scrolling */

/* Back to top button styles */
.back-to-top {
    position: fixed;
    right: 1rem;
    bottom: 1rem;
    width: 44px;
    height: 44px;
    background: #2563eb; /* blue-600 */
    color: #fff;
    border-radius: 9999px;
    box-shadow: 0 10px 20px rgba(37, 99, 235, 0.35);
    transition: transform .2s ease, opacity .2s ease;
    opacity: 0;
    transform: translateY(16px);
    z-index: 40;
}
.back-to-top.show {
    opacity: 1;
    transform: translateY(0);
}
.back-to-top:hover {
    background: #1d4ed8; /* blue-700 */
}
/* Floating WhatsApp action button */
.fab-whatsapp {
    position: fixed;
    right: 1rem;
    bottom: 5.5rem; /* above back-to-top */
    width: 52px;
    height: 52px;
    border-radius: 9999px;
    background: #25D366;
    color: #fff;
    display: flex;
    align-items: center;
    justify-content: center;
    box-shadow: 0 10px 20px rgba(37, 211, 102, 0.35);
    z-index: 45;
    transition: transform .2s ease, opacity .2s ease, background .2s ease;
}
.fab-whatsapp:hover { background: #1ebe5d; }

/* Floating AI chat button */
.fab-ai {
    position: fixed;
    right: 1rem;
    bottom: 10rem; /* above WhatsApp */
    width: 52px;
    height: 52px;
    border-radius: 9999px;
    background: #4f46e5; /* indigo-600 */
    color: #fff;
    display: flex;
    align-items: center;
    justify-content: center;
    box-shadow: 0 10px 20px rgba(79, 70, 229, 0.35);
    z-index: 45;
    transition: transform .2s ease, opacity .2s ease, background .2s ease;
}
.fab-ai:hover { background: #4338ca; }

/* Floating chat with seller button */
.fab-chat {
    position: fixed;
    right: 1rem;
    bottom: 14.5rem; /* above AI chat */
    width: 52px;
    height: 52px;
    border-radius: 9999px;
    background: #2563eb; /* blue-600 */
    color: #fff;
    display: flex;
    align-items: center;
    justify-content: center;
    box-shadow: 0 10px 20px rgba(37, 99, 235, 0.35);
    z-index: 45;
    transition: transform .2s ease, opacity .2s ease, background .2s ease;
}
.fab-chat:hover { 
    background: #1d4ed8; /* blue-700 */
    transform: translateY(-2px);
}

/* AI modal */
.ai-modal.hidden { display: none; }
.ai-modal { position: fixed; inset: 0; z-index: 50; }
.ai-modal__backdrop { position: absolute; inset: 0; background: rgba(0,0,0,.4); }
.ai-modal__panel {
    position: relative;
    max-width: 600px;
    margin: 10vh auto;
    background: #fff;
    border-radius: 0.75rem;
    box-shadow: 0 25px 50px -12px rgba(0,0,0,0.25);
    padding: 1rem 1.25rem 1.25rem;
}
.ai-modal__header { display: flex; align-items: center; justify-content: space-between; margin-bottom: .5rem; }
.ai-modal__close { font-size: 1.5rem; line-height: 1; color: #6b7280; }
.ai-modal__close:hover { color: #374151; }

/* Promise Fee Modal */
#promiseFeeModal {
    display: none;
    position: fixed;
    top: 0;
    left: 0;
    right: 0;
    bottom: 0;
    background-color: rgba(0, 0, 0, 0.5);
    z-index: 1000;
    align-items: center;
    justify-content: center;
    padding: 1rem;
}

#promiseFeeModal[style*="display: flex"] {
    display: flex !important;
}

.promise-fee-modal-content {
    background: white;
    border-radius: 0.5rem;
    max-width: 500px;
    width: 100%;
    max-height: 90vh;
    overflow-y: auto;
    box-shadow: 0 20px 25px -5px rgba(0, 0, 0, 0.1), 0 10px 10px -5px rgba(0, 0, 0, 0.04);
}

.promise-fee-modal-header {
    padding: 1.25rem 1.5rem;
    border-bottom: 1px solid #e5e7eb;
    display: flex;
    align-items: center;
    justify-content: space-between;
}

.promise-fee-modal-body {
    padding: 1.5rem;
}

.promise-fee-modal-close {
    color: #6b7280;
    background: none;
    border: none;
    font-size: 1.5rem;
    cursor: pointer;
    line-height: 1;
    padding: 0.25rem;
}

.promise-fee-modal-close:hover {
    color: #374151;
}

.promise-fee-feature-list {
    list-style-type: none;
    padding: 0;
    margin: 1.5rem 0;
}

.promise-fee-feature-list li {
    padding: 0.5rem 0;
    display: flex;
    align-items: flex-start;
    gap: 0.75rem;
}

.promise-fee-feature-list li:before {
    content: "✓";
    color: #10b981;
    font-weight: bold;
    flex-shrink: 0;
    margin-top: 0.25rem;
}
</style>

{% if has_promise_fee %}
<!-- Promise Fee Modal -->
<div id="promiseFeeModal" class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50 px-4 py-6" style="display: none;">
    <div class="bg-white rounded-lg shadow-xl max-w-md w-full max-h-[90vh] overflow-y-auto">
        <div class="p-6">
            <div class="flex justify-between items-center mb-4">
                <h3 class="text-xl font-semibold text-gray-900">✨ Promise Fee Available</h3>
                <button type="button" onclick="closePromiseFeeModal()" class="text-gray-400 hover:text-gray-500">
                    <span class="sr-only">Close</span>
                    <svg class="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12" />
                    </svg>
                </button>
            </div>
            <div class="space-y-4">
                <p class="text-gray-700">
                    This product offers a <span class="font-semibold">Promise Fee</span> option, allowing you to:
                </p>
                <ul class="promise-fee-feature-list">
                    <li>Reserve the product with a small fee</li>
                    <li>Inspect the product in person at a local office</li>
                    <li>Complete the payment only if you're satisfied</li>
                    <li>No obligation to purchase if the product doesn't meet your expectations</li>
                </ul>
                <p class="text-gray-700">
                    Look for the "Pay Promise Fee" option when selecting a variation.
                </p>
                <div class="mt-6">
                    <button type="button" onclick="closePromiseFeeModal()" class="w-full bg-indigo-600 text-white py-2 px-4 rounded-md hover:bg-indigo-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-indigo-500">
                        Got it, thanks!
                    </button>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Order Quantity Modal -->
<div id="orderModal" class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50 px-4 py-6" style="display: none;">
    <div class="bg-white rounded-lg shadow-xl max-w-md w-full max-h-[90vh] overflow-y-auto">
        <div class="p-6">
            <div class="flex justify-between items-center mb-4">
                <h3 class="text-xl font-semibold text-gray-900">Order Quantity</h3>
                <button type="button" onclick="closeOrderModal()" class="text-gray-400 hover:text-gray-500">
                    <span class="sr-only">Close</span>
                    <svg class="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12" />
                    </svg>
                </button>
            </div>
            
            <div class="mt-4">
                <!-- Product Info -->
                <div class="flex items-start mb-6 pb-4 border-b border-gray-100">
                    <div class="flex-shrink-0 w-20 h-20 bg-gray-100 rounded-md overflow-hidden">
                        <img src="{{ product.images.first.image.url }}" 
                             alt="{{ product.name }}" 
                             class="w-full h-full object-cover object-center">
                    </div>
                    <div class="ml-4 flex-1">
                        <h4 class="font-medium text-gray-900">{{ product.name }}</h4>
                        {% if product.sku %}
                        <p class="text-sm text-gray-500">SKU: {{ product.sku }}</p>
                        {% endif %}
                        <p class="mt-1 text-lg font-semibold text-blue-600">Ksh{{ product.price|floatformat:2 }}</p>
                    </div>
                </div>

                <form id="orderForm" method="post" action="{% url 'home:quick_checkout' %}" class="space-y-4" onsubmit="return handleOrderFormSubmit(event)">
                    {% csrf_token %}
                    <input type="hidden" name="next" value="{{ request.get_full_path }}">
                    <input type="hidden" name="product_id" value="{{ product.id }}">
                    
                    {% if product.variations.all %}
                    <div class="mt-4 border-t border-gray-200 pt-4">
                        <h4 class="text-sm font-medium text-gray-900 mb-3">Select Variations</h4>
                        <div class="space-y-3">
                            {% for variation in product.variations.all %}
                            <div class="variation-item p-3 rounded-md border border-gray-200">
                                <div class="flex justify-between items-start">
                                    <div>
                                        <p class="text-sm font-medium text-gray-900">{{ variation.name }}</p>
                                        <p class="text-sm text-gray-500">
                                            Ksh{{ variation.price|floatformat:2 }}
                                            {% if variation.stock_quantity %}
                                            • {{ variation.stock_quantity }} in stock
                                            {% endif %}
                                        </p>
                                    </div>
                                    <div class="flex items-center">
                                        <button type="button" 
                                                onclick="updateVariationQuantity('{{ variation.id }}', -1)" 
                                                class="p-1 text-gray-500 hover:text-gray-700">
                                            <svg class="h-4 w-4" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M20 12H4" />
                                            </svg>
                                        </button>
                                        <input type="number" 
                                               name="variation_{{ variation.id }}" 
                                               id="variation_{{ variation.id }}" 
                                               min="0" 
                                               value="0" 
                                               step="1"
                                               class="w-16 mx-2 text-center border rounded-md py-1 text-sm variation-quantity"
                                               data-price="{{ variation.price|floatformat:2 }}"
                                               data-moq="{{ variation.moq }}"
                                               onchange="updateOrderTotal()">
                                        <button type="button" 
                                                onclick="updateVariationQuantity('{{ variation.id }}', 1)" 
                                                class="p-1 text-gray-500 hover:text-gray-700">
                                            <svg class="h-4 w-4" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 4v16m8-8H4" />
                                            </svg>
                                        </button>
                                    </div>
                                </div>
                            </div>
                            {% endfor %}
                        </div>
                    </div>
                    {% else %}
                    <div class="mt-4 border-t border-gray-200 pt-4">
                        <h4 class="text-sm font-medium text-gray-900 mb-3">Order Quantity</h4>
                        <div class="flex items-center justify-between p-3 rounded-md border border-blue-200 bg-blue-50">
                            <div>
                                <p class="text-sm font-medium text-gray-900">{{ product.name }}</p>
                                <p class="text-sm text-gray-500">MOQ: {{ product.moq }} units</p>
                            </div>
                            <div class="flex items-center">
                                <button type="button" onclick="decrementQuantity()" class="p-1 text-gray-500 hover:text-gray-700">
                                    <svg class="h-4 w-4" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M20 12H4" />
                                    </svg>
                                </button>
                                <input type="number" 
                                       name="quantity" 
                                       id="quantity" 
                                       min="{{ product.moq }}" 
                                       value="{{ product.moq }}" 
                                       step="{{ product.moq }}"
                                       class="w-16 mx-2 text-center border rounded-md py-1 text-sm"
                                       onchange="updateOrderTotal()">
                                <button type="button" onclick="incrementQuantity()" class="p-1 text-gray-500 hover:text-gray-700">
                                    <svg class="h-4 w-4" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 4v16m8-8H4" />
                                    </svg>
                                </button>
                            </div>
                        </div>
                    </div>
                    {% endif %}
                    
                    <div class="mt-6 pt-4 border-t border-gray-200">
                        <div class="flex justify-between items-center mb-4">
                            <p class="text-sm font-medium text-gray-900">Order Total</p>
                            <p class="text-lg font-semibold text-blue-600">Ksh <span id="orderTotal">{{ product.price|floatformat:2 }}</span></p>
                        </div>
                        <button type="submit" 
                                class="w-full flex justify-center py-2 px-4 border border-transparent rounded-md shadow-sm text-sm font-medium text-white bg-blue-600 hover:bg-blue-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-blue-500">
                            Proceed to Order
                        </button>
                    </div>
                </form>
            </div>
        </div>
    </div>
</div>

<script>
// Function to handle form submission
function handleOrderFormSubmit(event) {
    event.preventDefault();
    
    // Create form data
    const formData = new FormData();
    const form = event.target;
    
    // Add all form data
    new FormData(form).forEach((value, key) => {
        formData.append(key, value);
    });
    
    // Add variation quantities
    document.querySelectorAll('.variation-quantity').forEach(input => {
        const quantity = parseInt(input.value) || 0;
        if (quantity > 0) {
            const variationId = input.id.replace('variation_', '');
            formData.append(`quantity_${variationId}`, quantity);
        }
    });
    
    // Submit the form via fetch
    fetch(form.action, {
        method: 'POST',
        body: formData,
        headers: {
            'X-Requested-With': 'XMLHttpRequest',
            'X-CSRFToken': document.querySelector('[name=csrfmiddlewaretoken]').value
        }
    })
    .then(response => {
        if (response.redirected) {
            window.location.href = response.url;
        } else {
            return response.json().then(data => {
                if (data.redirect_url) {
                    window.location.href = data.redirect_url;
                } else {
                    throw new Error('Invalid response from server');
                }
            });
        }
    })
    .catch(error => {
        console.error('Error:', error);
        alert('An error occurred. Please try again.');
    });
    
    return false;
}

// Make functions globally available
window.openOrderModal = function() {
    document.getElementById('orderModal').style.display = 'flex';
    updateOrderTotal();
};

window.closeOrderModal = function() {
    document.getElementById('orderModal').style.display = 'none';
};

// Track product price and variations
const productPrice = parseFloat('{{ product.price|floatformat:2 }}');
let quantity = parseInt('{{ product.moq|default:1 }}');

function incrementQuantity() {
    const input = document.getElementById('quantity');
    const moq = parseInt('{{ product.moq|default:1 }}');
    input.stepUp(moq);
    quantity = parseInt(input.value);
    updateOrderTotal();
}

function decrementQuantity() {
    const input = document.getElementById('quantity');
    const moq = parseInt('{{ product.moq|default:1 }}');
    if (input.value > moq) {
        input.stepDown(moq);
        quantity = parseInt(input.value);
        updateOrderTotal();
    }
}

function updateVariationQuantity(variationId, change) {
    const input = document.getElementById('variation_' + variationId);
    const currentValue = parseInt(input.value) || 0;
    const moq = parseInt(input.dataset.moq) || 1;
    let newValue = currentValue + change;
    
    // If increasing from 0, jump to MOQ
    if (change > 0 && currentValue === 0) {
        newValue = moq;
    } 
    // If decreasing to below MOQ, go to 0
    else if (newValue < moq && newValue > 0) {
        newValue = 0;
    }
    // Ensure not going below 0
    
    input.value = newValue;
    updateOrderTotal();
}

function updateOrderTotal() {
    let total = 0;
{{ ... }}
    
    // Check if we have variations
    const variationQuantities = document.querySelectorAll('.variation-quantity');
    if (variationQuantities.length > 0) {
        // Calculate total from variations
        variationQuantities.forEach(input => {
            const quantity = parseInt(input.value) || 0;
            if (quantity > 0) {
                const price = parseFloat(input.dataset.price);
                total += quantity * price;
                hasValidQuantity = true;
            }
        });
    } else {
        // Fallback to regular product price
        total = productPrice * quantity;
        hasValidQuantity = quantity > 0;
    }
    
    // Update order button state
    const orderButton = document.querySelector('#orderForm button[type="submit"]');
    if (orderButton) {
        orderButton.disabled = !hasValidQuantity;
    }
    
    document.getElementById('orderTotal').textContent = 'Ksh' + total.toFixed(2);
}

// Close modal when clicking outside
window.addEventListener('click', function(event) {
    const modal = document.getElementById('orderModal');
    if (event.target === modal) {
        closeOrderModal();
    }
});
</script>

<script>
// Show promise fee modal on page load if it exists
window.addEventListener('DOMContentLoaded', function() {
    const promiseFeeModal = document.getElementById('promiseFeeModal');
    if (promiseFeeModal) {
        // Only show if not already shown in this session
        if (!sessionStorage.getItem('promiseFeeModalShown')) {
            promiseFeeModal.style.display = 'flex';
            sessionStorage.setItem('promiseFeeModalShown', 'true');
        }
    }
});

function closePromiseFeeModal() {
    const modal = document.getElementById('promiseFeeModal');
    if (modal) {
        modal.style.display = 'none';
    }
}

// Close modal when clicking outside the content
window.addEventListener('click', function(event) {
    const modal = document.getElementById('promiseFeeModal');
    if (event.target === modal) {
        closePromiseFeeModal();
    }
});

// Tab switching functionality
function showTab(tabId, contentId, button) {
    // Hide all tab contents
    document.querySelectorAll('[id$="-content"]').forEach(content => {
        content.classList.add('hidden');
    });
    
    // Remove active state from all tab buttons
    document.querySelectorAll('[onclick^="showTab"]').forEach(btn => {
        btn.classList.remove('border-blue-500', 'text-blue-600');
        btn.classList.add('border-transparent', 'text-gray-500', 'hover:text-gray-700', 'hover:border-gray-300');
    });
    
    // Show the selected tab content
    document.getElementById(contentId).classList.remove('hidden');
    
    // Add active state to the clicked button
    button.classList.remove('border-transparent', 'text-gray-500', 'hover:text-gray-700', 'hover:border-gray-300');
    button.classList.add('border-blue-500', 'text-blue-600');
}

// Initialize first tab as active by default
document.addEventListener('DOMContentLoaded', function() {
    const firstTab = document.querySelector('[onclick^="showTab"]');
    if (firstTab) {
        firstTab.click();
    }
});
</script>
{% endif %}

{% endblock %}

